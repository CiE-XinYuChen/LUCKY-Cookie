{% extends "base.html" %}

{% block title %}抽签管理 - 宿舍抽签系统{% endblock %}

{% block content %}
<div class="container">
    <h1 id="pageTitle">抽签管理</h1>
    
    <!-- 管理员抽签设置 -->
    <div id="adminSection" style="display: none;">
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">抽签设置</h3>
            </div>
            <div class="card-content">
                <button type="button" class="btn btn-primary" onclick="showCreateLotteryModal()">创建新抽签</button>
            </div>
        </div>
    </div>

    <!-- 抽签列表 -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3 class="card-title">抽签列表</h3>
        </div>
        <div class="card-content" id="lotteryList">
            <!-- 抽签列表将通过JavaScript加载 -->
        </div>
    </div>

    <!-- 抽签结果 -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">抽签结果</h3>
        </div>
        <div class="card-content" id="lotteryResults">
            <!-- 抽签结果将通过JavaScript加载 -->
        </div>
    </div>
</div>

<!-- 创建抽签模态框 -->
<div id="createLotteryModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">创建新抽签</h3>
        </div>
        <div class="modal-content">
            <form id="createLotteryForm">
                <div class="form-group">
                    <label class="form-label">抽签名称</label>
                    <input type="text" id="lotteryName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">公布时间</label>
                    <input type="datetime-local" id="lotteryTime" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="lotteryRoomType" class="form-input" required>
                        <option value="">请选择房间类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateLotteryModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createLottery()">创建</button>
        </div>
    </div>
</div>

<!-- 房间分配模态框 -->
<div id="roomAllocationModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">设置房间分配</h3>
        </div>
        <div class="modal-content">
            <form id="roomAllocationForm">
                <div class="form-group">
                    <label class="form-label">四人间数量</label>
                    <input type="number" id="room4Count" class="form-input" min="0" value="0" required>
                    <small class="form-help">四人间可容纳人数: <span id="room4Capacity">0</span></small>
                </div>
                <div class="form-group">
                    <label class="form-label">六人间数量</label>
                    <input type="number" id="room6Count" class="form-input" min="0" value="0" required>
                    <small class="form-help">六人间可容纳人数: <span id="room6Capacity">0</span></small>
                </div>
                <div class="form-group">
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-top: 16px;">
                        <div><strong>总床位数:</strong> <span id="totalBeds">0</span></div>
                        <div><strong>参与用户数:</strong> <span id="totalUsers">0</span></div>
                        <div id="allocationWarning" style="color: #d32f2f; margin-top: 8px; display: none;">
                            ⚠️ 床位数不足，部分用户将无法分配
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideRoomAllocationModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="confirmRoomAllocation()">确认分配</button>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.form-help {
    font-size: 0.875rem;
    color: #666;
    margin-top: 4px;
    display: block;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let isAdmin = false;
let lotterySettings = [];

document.addEventListener('DOMContentLoaded', function() {
    if (!requireAuth()) return;
    
    const user = getCurrentUser();
    isAdmin = user && user.is_admin;
    
    if (isAdmin) {
        document.getElementById('pageTitle').textContent = '抽签管理';
        document.getElementById('adminSection').style.display = 'block';
    } else {
        document.getElementById('pageTitle').textContent = '抽签结果';
    }
    
    loadLotterySettings();
    loadLotteryResults();
});

async function loadLotterySettings() {
    try {
        const response = await api.getLotterySettings();
        lotterySettings = response.settings;
        
        if (lotterySettings.length === 0) {
            document.getElementById('lotteryList').innerHTML = '<p>暂无抽签设置</p>';
            return;
        }
        
        const listHtml = lotterySettings.map(setting => `
            <div class="card" style="margin-bottom: 16px;">
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
                        <div><strong>抽签名称：</strong> ${setting.lottery_name}</div>
                        <div><strong>公布时间：</strong> ${formatDate(setting.lottery_time)}</div>
                        <div><strong>房间类型：</strong> ${setting.room_type}人间</div>
                        <div><strong>状态：</strong> ${setting.is_published ? '已公布' : '未公布'}</div>
                    </div>
                    ${isAdmin ? `
                        <div style="display: flex; gap: 8px;">
                            ${!setting.is_published ? `
                                <button class="btn btn-success" onclick="showRoomAllocationModal(${setting.id})">立即公布</button>
                            ` : ''}
                            <button class="btn btn-outline" onclick="viewLotteryResults(${setting.id})">查看结果</button>
                        </div>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
        document.getElementById('lotteryList').innerHTML = listHtml;
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function loadLotteryResults(lotteryId = null) {
    try {
        const response = await api.getLotteryResults(lotteryId);
        
        if (response.results.length === 0) {
            document.getElementById('lotteryResults').innerHTML = '<p>暂无抽签结果</p>';
            return;
        }
        
        // 按抽签号码排序
        const sortedResults = response.results.sort((a, b) => a.lottery_number - b.lottery_number);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>抽签号码</th>
                        <th>学生姓名</th>
                        <th>分组号</th>
                        <th>房间类型</th>
                        <th>抽签时间</th>
                        ${isAdmin ? '<th>操作</th>' : ''}
                    </tr>
                </thead>
                <tbody>
                    ${sortedResults.map(result => `
                        <tr>
                            <td><strong>${result.lottery_number}</strong></td>
                            <td>${result.user_name}</td>
                            <td>${result.group_number || '未分组'}</td>
                            <td>${result.room_type ? `${result.room_type}人间` : '未分配'}</td>
                            <td>${formatDate(result.created_at)}</td>
                            ${isAdmin ? `
                                <td>
                                    <button class="btn btn-outline" onclick="editLotteryResult(${result.id})">编辑</button>
                                </td>
                            ` : ''}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('lotteryResults').innerHTML = table;
    } catch (error) {
        document.getElementById('lotteryResults').innerHTML = '<p>加载抽签结果失败</p>';
    }
}

function showCreateLotteryModal() {
    document.getElementById('createLotteryModal').style.display = 'flex';
    
    // 设置默认时间为当前时间
    const now = new Date();
    const localDatetime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('lotteryTime').value = localDatetime;
}

function hideCreateLotteryModal() {
    document.getElementById('createLotteryModal').style.display = 'none';
    document.getElementById('createLotteryForm').reset();
}

async function createLottery() {
    const name = document.getElementById('lotteryName').value;
    const time = document.getElementById('lotteryTime').value;
    const roomType = document.getElementById('lotteryRoomType').value;
    
    if (!name || !time || !roomType) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    try {
        await api.createLotterySetting({
            lottery_name: name,
            lottery_time: time,
            room_type: roomType
        });
        showAlert('抽签创建成功', 'success');
        hideCreateLotteryModal();
        loadLotterySettings();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

let currentLotteryId = null;

async function showRoomAllocationModal(settingId) {
    currentLotteryId = settingId;
    
    try {
        // 获取参与用户数
        const response = await api.getUsers(1, 1000); // 获取所有用户
        const nonAdminUsers = response.users.filter(user => !user.is_admin);
        const totalUsers = nonAdminUsers.length;
        
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('roomAllocationModal').style.display = 'flex';
        
        // 初始化计算
        updateRoomCapacity();
        
        // 监听输入变化
        document.getElementById('room4Count').addEventListener('input', updateRoomCapacity);
        document.getElementById('room6Count').addEventListener('input', updateRoomCapacity);
        
    } catch (error) {
        showAlert('获取用户信息失败: ' + error.message, 'error');
    }
}

function hideRoomAllocationModal() {
    document.getElementById('roomAllocationModal').style.display = 'none';
    document.getElementById('roomAllocationForm').reset();
    currentLotteryId = null;
}

function updateRoomCapacity() {
    const room4Count = parseInt(document.getElementById('room4Count').value) || 0;
    const room6Count = parseInt(document.getElementById('room6Count').value) || 0;
    const totalUsers = parseInt(document.getElementById('totalUsers').textContent) || 0;
    
    const room4Capacity = room4Count * 4;
    const room6Capacity = room6Count * 6;
    const totalBeds = room4Capacity + room6Capacity;
    
    document.getElementById('room4Capacity').textContent = room4Capacity;
    document.getElementById('room6Capacity').textContent = room6Capacity;
    document.getElementById('totalBeds').textContent = totalBeds;
    
    const warning = document.getElementById('allocationWarning');
    if (totalBeds < totalUsers) {
        warning.style.display = 'block';
        warning.textContent = `⚠️ 床位数不足，将有 ${totalUsers - totalBeds} 名用户无法分配`;
    } else {
        warning.style.display = 'none';
    }
}

async function confirmRoomAllocation() {
    if (!currentLotteryId) return;
    
    const room4Count = parseInt(document.getElementById('room4Count').value) || 0;
    const room6Count = parseInt(document.getElementById('room6Count').value) || 0;
    
    if (room4Count === 0 && room6Count === 0) {
        showAlert('四人间和六人间数量不能都为0', 'error');
        return;
    }
    
    if (!confirm('确定要按此配置立即公布抽签结果吗？公布后将自动生成所有用户的抽签号码。')) return;
    
    try {
        const response = await api.publishLottery(currentLotteryId, {
            room_4_count: room4Count,
            room_6_count: room6Count
        });
        
        showAlert(`抽签结果已公布！共有 ${response.total_participants} 名学生参与，已分配 ${response.allocated_participants} 名学生到 ${response.room_4_groups} 个四人间和 ${response.room_6_groups} 个六人间`, 'success');
        
        hideRoomAllocationModal();
        loadLotterySettings();
        loadLotteryResults();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function viewLotteryResults(lotteryId) {
    loadLotteryResults(lotteryId);
}

async function editLotteryResult(resultId) {
    const newLotteryNumber = prompt('请输入新的抽签号码：');
    if (!newLotteryNumber || isNaN(newLotteryNumber)) {
        showAlert('请输入有效的抽签号码', 'error');
        return;
    }
    
    const newGroupNumber = prompt('请输入新的分组号（可留空）：');
    
    try {
        const updateData = { lottery_number: parseInt(newLotteryNumber) };
        if (newGroupNumber && !isNaN(newGroupNumber)) {
            updateData.group_number = parseInt(newGroupNumber);
        }
        
        await api.updateLotteryResult(resultId, updateData);
        showAlert('抽签结果更新成功', 'success');
        loadLotteryResults();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 模态框事件处理
document.getElementById('createLotteryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCreateLotteryModal();
    }
});
</script>
{% endblock %}
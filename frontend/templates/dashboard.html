{% extends "base.html" %}

{% block title %}个人中心 - 宿舍抽签系统{% endblock %}

{% block content %}
<div class="container">
    <!-- 页面头部 -->
    <header class="dashboard-header">
        <div class="header-content">
            <h1>个人中心</h1>
            <p class="header-subtitle">欢迎使用宿舍抽签系统，这里是您的个人信息和抽签状态总览</p>
        </div>
        
        <!-- 快速状态概览 -->
        <section class="status-overview" id="statusOverview">
            <div class="loading-skeleton">
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
                <div class="skeleton-card"></div>
            </div>
        </section>
    </header>
    
    <!-- 主要内容区域 -->
    <main class="dashboard-main">
        <!-- 用户信息卡片 -->
        <section class="dashboard-section" data-section="user-info">
            <div class="section-card user-info-card">
                <header class="section-header">
                    <h2 class="section-title">
                        个人信息
                    </h2>
                </header>
                <div class="section-content">
                    <div id="userInfo" class="user-info-content">
                        <div class="loading-skeleton">
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                            <div class="skeleton-text"></div>
                        </div>
                    </div>
                    <div class="section-actions">
                        <button type="button" class="btn btn-outline" id="changePasswordBtn">
                            修改密码
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 抽签结果卡片 -->
        <section class="dashboard-section" data-section="lottery-results">
            <div class="section-card lottery-results-card">
                <header class="section-header">
                    <h2 class="section-title">
                        我的抽签结果
                    </h2>
                </header>
                <div class="section-content">
                    <div id="lotteryResults" class="lottery-results-content">
                        <div class="loading-skeleton">
                            <div class="skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 宿舍选择卡片 -->
        <section class="dashboard-section" data-section="room-selection">
            <div class="section-card room-selection-card">
                <header class="section-header">
                    <h2 class="section-title">
                        我的宿舍选择
                    </h2>
                </header>
                <div class="section-content">
                    <div id="roomSelection" class="room-selection-content">
                        <div class="loading-skeleton">
                            <div class="skeleton-card"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- 修改密码模态框 -->
<div id="changePasswordModal" class="modal-overlay" style="display: none;" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
    <div class="modal" role="document">
        <header class="modal-header">
            <h3 id="modalTitle" class="modal-title">修改密码</h3>
            <button type="button" class="modal-close" aria-label="关闭">
                ×
            </button>
        </header>
        <div class="modal-content">
            <form id="changePasswordForm" novalidate>
                <div class="form-group">
                    <label class="form-label" for="oldPassword">当前密码</label>
                    <input type="password" id="oldPassword" class="form-input" required aria-describedby="oldPasswordError">
                    <div id="oldPasswordError" class="form-error" role="alert"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="newPassword">新密码</label>
                    <input type="password" id="newPassword" class="form-input" required minlength="6" aria-describedby="newPasswordError">
                    <div id="newPasswordError" class="form-error" role="alert"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="confirmPassword">确认新密码</label>
                    <input type="password" id="confirmPassword" class="form-input" required minlength="6" aria-describedby="confirmPasswordError">
                    <div id="confirmPasswordError" class="form-error" role="alert"></div>
                </div>
            </form>
        </div>
        <footer class="modal-actions">
            <button type="button" class="btn btn-outline" id="cancelPasswordBtn">取消</button>
            <button type="button" class="btn btn-primary" id="confirmPasswordBtn">
                <span class="btn-text">修改</span>
                <span class="btn-loading" style="display: none;"></span>
            </button>
        </footer>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/**
 * 个人中心仪表板管理器
 * 使用模块化架构重构，提供更好的错误处理和用户体验
 */
class DashboardManager {
    constructor() {
        this.state = {
            userData: null,
            lotteryResults: null,
            roomSelection: null,
            isLoading: false,
            errors: new Map()
        };
        
        this.retryConfig = {
            maxRetries: 3,
            baseDelay: 1000,
            maxDelay: 5000
        };
        
        this.abortController = new AbortController();
        this.initializeComponents();
    }
    
    /**
     * 初始化组件和事件监听器
     */
    initializeComponents() {
        this.bindEvents();
        this.initializeModal();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.initialize());
        } else {
            this.initialize();
        }
    }
    
    /**
     * 绑定事件监听器
     */
    bindEvents() {
        // 防止内存泄漏，确保事件监听器只绑定一次
        document.addEventListener('click', this.handleGlobalClick.bind(this), { 
            passive: true,
            signal: this.abortController.signal 
        });
        
        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => this.cleanup(), { 
            signal: this.abortController.signal 
        });
    }
    
    /**
     * 全局点击事件处理
     */
    handleGlobalClick(event) {
        const target = event.target.closest('button, [data-action]');
        if (!target) return;
        
        const action = target.id || target.dataset.action;
        
        switch (action) {
            case 'changePasswordBtn':
                this.showPasswordModal();
                break;
            case 'confirmPasswordBtn':
                this.handlePasswordChange(event);
                break;
            case 'cancelPasswordBtn':
                this.hidePasswordModal();
                break;
        }
    }
    
    /**
     * 初始化模态框
     */
    initializeModal() {
        const modal = document.getElementById('changePasswordModal');
        if (!modal) return;
        
        // ESC键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                this.hidePasswordModal();
            }
        }, { signal: this.abortController.signal });
        
        // 点击背景关闭模态框
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                this.hidePasswordModal();
            }
        }, { signal: this.abortController.signal });
        
        // 关闭按钮
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.hidePasswordModal(), {
                signal: this.abortController.signal
            });
        }
    }
    
    /**
     * 主要初始化方法
     */
    async initialize() {
        try {
            // 检查API可用性
            if (typeof api === 'undefined') {
                throw new Error('API未初始化');
            }
            
            // 检查认证状态
            if (!requireAuth()) {
                return;
            }
            
            // 检查是否为管理员用户，如果是则重定向到管理页面
            if (isAdmin()) {
                showAlert('管理员用户请使用管理页面', 'info');
                window.location.href = '/admin';
                return;
            }
            
            // 并发加载所有数据
            await this.loadAllData();
            
        } catch (error) {
            this.handleCriticalError('系统初始化失败', error);
        }
    }
    
    /**
     * 并发加载所有数据
     */
    async loadAllData() {
        this.setState({ isLoading: true });
        
        try {
            // 使用Promise.allSettled确保部分失败不影响其他数据加载
            const results = await Promise.allSettled([
                this.loadUserInfo(),
                this.loadLotteryResults(),
                this.loadRoomSelection()
            ]);
            
            // 检查是否有任何加载失败
            const failures = results.filter(result => result.status === 'rejected');
            if (failures.length > 0) {
                console.warn('部分数据加载失败:', failures);
            }
            
            // 加载状态概览（依赖于其他数据）
            await this.loadStatusOverview();
            
        } catch (error) {
            this.handleError('数据加载失败', error);
        } finally {
            this.setState({ isLoading: false });
        }
    }
    
    /**
     * 加载用户信息
     */
    async loadUserInfo() {
        return this.withRetry(async () => {
            const container = document.getElementById('userInfo');
            this.showLoading(container);
            
            try {
                const response = await api.getProfile();
                const userData = response.user;
                
                this.setState({ userData });
                this.renderUserInfo(userData, container);
                
            } catch (error) {
                this.showError(container, '用户信息加载失败');
                throw error;
            }
        }, 'userInfo');
    }
    
    /**
     * 渲染用户信息
     */
    renderUserInfo(userData, container) {
        const userInfoHTML = `
            <div class="user-info-grid">
                <div class="info-item">
                    <div class="info-label">
                        姓名
                    </div>
                    <div class="info-value primary">${this.escapeHtml(userData.name)}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">
                        用户名
                    </div>
                    <div class="info-value secondary">${this.escapeHtml(userData.username)}</div>
                </div>
            </div>
        `;
        
        container.innerHTML = userInfoHTML;
    }
    
    /**
     * 加载抽签结果
     */
    async loadLotteryResults() {
        return this.withRetry(async () => {
            const container = document.getElementById('lotteryResults');
            this.showLoading(container);
            
            try {
                const response = await api.getLotteryResults();
                const results = response.results || [];
                
                this.setState({ lotteryResults: results });
                this.renderLotteryResults(results, container);
                
            } catch (error) {
                this.showError(container, '抽签结果加载失败');
                throw error;
            }
        }, 'lotteryResults');
    }
    
    /**
     * 渲染抽签结果
     */
    renderLotteryResults(results, container) {
        if (results.length === 0) {
            const hasClicked = localStorage.getItem('lottery_clicked');
            
            if (hasClicked) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <p>您已参与抽签，请等待管理员公布抽签结果。</p>
                    </div>
                `;
            } else {
                container.innerHTML = this.renderLotteryPrompt();
            }
            return;
        }
        
        const resultsHTML = results.map(result => this.renderLotteryResult(result)).join('');
        container.innerHTML = resultsHTML;
    }
    
    /**
     * 渲染抽签提示
     */
    renderLotteryPrompt() {
        return `
            <div class="lottery-prompt">
                <h3 class="prompt-title">宿舍抽签</h3>
                <p class="prompt-description">欢迎参与宿舍抽签！系统将为您随机分配抽签号码，根据号码顺序选择心仪的宿舍</p>
                <button type="button" class="btn btn-primary lottery-btn" data-action="participate-lottery">
                    <span class="btn-text">开始抽签</span>
                    <span class="btn-loading" style="display: none;"></span>
                </button>
                <div class="prompt-note">
                    抽签结果将由管理员统一发布
                </div>
            </div>
        `;
    }
    
    /**
     * 渲染单个抽签结果
     */
    renderLotteryResult(result) {
        return `
            <div class="result-card">
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">抽签号码</div>
                        <div class="result-value primary">#${result.lottery_number}</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">分配房间类型</div>
                        <div class="result-value">${result.room_type ? `${result.room_type}人间` : '未分配'}</div>
                    </div>
                </div>
                ${result.room_type ? `
                    <div class="alert alert-info">
                        您已被分配到${result.room_type}人间，请到"宿舍选择"页面选择具体床位。
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    /**
     * 加载宿舍选择信息
     */
    async loadRoomSelection() {
        return this.withRetry(async () => {
            const container = document.getElementById('roomSelection');
            this.showLoading(container);
            
            try {
                const response = await api.getMySelection();
                const selection = response.selection;
                
                this.setState({ roomSelection: selection });
                this.renderRoomSelection(selection, container);
                
            } catch (error) {
                this.showError(container, '宿舍选择信息加载失败');
                throw error;
            }
        }, 'roomSelection');
    }
    
    /**
     * 渲染宿舍选择
     */
    renderRoomSelection(selection, container) {
        if (!selection) {
            const hasLotteryResult = this.state.lotteryResults && this.state.lotteryResults.length > 0;
            
            if (!hasLotteryResult) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <p>您还没有抽签结果，无法选择宿舍。请等待管理员进行抽签分配。</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-selection">
                        <p>您还没有选择宿舍</p>
                        <a href="/room-selection" class="btn btn-primary">立即选择宿舍</a>
                    </div>
                `;
            }
            return;
        }
        
        container.innerHTML = this.renderSelectionDetails(selection);
    }
    
    /**
     * 渲染选择详情
     */
    renderSelectionDetails(selection) {
        return `
            <div class="selection-card">
                <div class="selection-grid">
                    <div class="selection-item">
                        <div class="selection-label">楼栋</div>
                        <div class="selection-value">${this.escapeHtml(selection.building_name)}</div>
                    </div>
                    <div class="selection-item">
                        <div class="selection-label">房间号</div>
                        <div class="selection-value">${this.escapeHtml(selection.room_number)}</div>
                    </div>
                    <div class="selection-item">
                        <div class="selection-label">床位号</div>
                        <div class="selection-value">${this.escapeHtml(selection.bed_number)}</div>
                    </div>
                    <div class="selection-item">
                        <div class="selection-label">选择时间</div>
                        <div class="selection-value">${formatDate(selection.selected_at)}</div>
                    </div>
                    <div class="selection-item">
                        <div class="selection-label">确认状态</div>
                        <div class="selection-value">
                            <span class="badge ${selection.is_confirmed ? 'badge-success' : 'badge-warning'}">
                                ${selection.is_confirmed ? '已确认' : '未确认'}
                            </span>
                        </div>
                    </div>
                </div>
                ${this.renderSelectionActions(selection)}
            </div>
        `;
    }
    
    /**
     * 渲染选择操作按钮
     */
    renderSelectionActions(selection) {
        if (selection.is_confirmed) {
            return `
                <div class="alert alert-success">
                    您的宿舍选择已确认
                </div>
            `;
        }
        
        return `
            <div class="selection-actions">
                <a href="/room-selection" class="btn btn-outline">
                    修改选择
                </a>
                <button type="button" class="btn btn-success" data-action="confirm-selection">
                    <span class="btn-text">确认选择</span>
                    <span class="btn-loading" style="display: none;"></span>
                </button>
            </div>
        `;
    }
    
    /**
     * 加载状态概览
     */
    async loadStatusOverview() {
        try {
            const container = document.getElementById('statusOverview');
            const statusData = this.calculateStatusData();
            
            container.innerHTML = this.renderStatusOverview(statusData);
            
        } catch (error) {
            console.error('状态概览加载失败:', error);
            this.showError(document.getElementById('statusOverview'), '状态加载失败');
        }
    }
    
    /**
     * 计算状态数据
     */
    calculateStatusData() {
        const { lotteryResults, roomSelection } = this.state;
        
        // 抽签状态
        let lotteryStatus = { text: '未公布', color: 'var(--gray-400)', icon: 'help-circle' };
        
        if (lotteryResults && lotteryResults.length > 0) {
            const result = lotteryResults[0];
            if (result.room_type) {
                lotteryStatus = {
                    text: `已分配 ${result.room_type}人间`,
                    color: 'var(--success-color)',
                    icon: 'check-circle'
                };
            } else {
                lotteryStatus = {
                    text: '已参与抽签',
                    color: 'var(--warning-color)',
                    icon: 'clock'
                };
            }
        }
        
        // 宿舍状态
        let roomStatus = { text: '未选择', color: 'var(--gray-400)', icon: 'home' };
        
        if (roomSelection) {
            if (roomSelection.is_confirmed) {
                roomStatus = {
                    text: `${roomSelection.building_name} ${roomSelection.room_number}-${roomSelection.bed_number}`,
                    color: 'var(--success-color)',
                    icon: 'check-circle'
                };
            } else {
                roomStatus = {
                    text: '已选择待确认',
                    color: 'var(--warning-color)',
                    icon: 'clock'
                };
            }
        }
        
        return { lotteryStatus, roomStatus };
    }
    
    /**
     * 渲染状态概览
     */
    renderStatusOverview(statusData) {
        const { lotteryStatus, roomStatus } = statusData;
        
        return `
            <div class="status-card">
                <div class="status-label">抽签状态</div>
                <div class="status-value" style="color: ${lotteryStatus.color};">${lotteryStatus.text}</div>
            </div>
            <div class="status-card">
                <div class="status-label">宿舍状态</div>
                <div class="status-value" style="color: ${roomStatus.color};">${roomStatus.text}</div>
            </div>
        `;
    }
    
    /**
     * 获取SVG图标
     */
    getIcon(iconName) {
        const icons = {
            'help-circle': '',
            'check-circle': '',
            'clock': '',
            'home': '',
            'user': ''
        };
        
        return icons[iconName] || icons['help-circle'];
    }
    
    /**
     * 密码相关方法
     */
    showPasswordModal() {
        const modal = document.getElementById('changePasswordModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.querySelector('#oldPassword')?.focus();
        }
    }
    
    hidePasswordModal() {
        const modal = document.getElementById('changePasswordModal');
        if (modal) {
            modal.style.display = 'none';
            this.clearFormErrors('changePasswordForm');
            document.getElementById('changePasswordForm')?.reset();
        }
    }
    
    async handlePasswordChange(event) {
        event.preventDefault();
        
        const button = event.target;
        const form = document.getElementById('changePasswordForm');
        
        if (!this.validatePasswordForm(form)) {
            return;
        }
        
        const formData = new FormData(form);
        const oldPassword = document.getElementById('oldPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        
        this.setButtonLoading(button, true);
        
        try {
            await api.changePassword(oldPassword, newPassword);
            showAlert('密码修改成功', 'success');
            this.hidePasswordModal();
            
        } catch (error) {
            this.showFormError('changePasswordForm', error.message);
        } finally {
            this.setButtonLoading(button, false);
        }
    }
    
    validatePasswordForm(form) {
        this.clearFormErrors('changePasswordForm');
        
        const oldPassword = form.querySelector('#oldPassword').value;
        const newPassword = form.querySelector('#newPassword').value;
        const confirmPassword = form.querySelector('#confirmPassword').value;
        
        let isValid = true;
        
        if (!oldPassword) {
            this.showFieldError('oldPassword', '请输入当前密码');
            isValid = false;
        }
        
        if (!newPassword || newPassword.length < 6) {
            this.showFieldError('newPassword', '新密码长度不能少于6位');
            isValid = false;
        }
        
        if (newPassword !== confirmPassword) {
            this.showFieldError('confirmPassword', '新密码和确认密码不匹配');
            isValid = false;
        }
        
        return isValid;
    }
    
    /**
     * 工具方法
     */
    setState(newState) {
        Object.assign(this.state, newState);
    }
    
    showLoading(container) {
        if (container) {
            container.innerHTML = `
                <div class="loading-skeleton">
                    <div class="skeleton-text"></div>
                    <div class="skeleton-text"></div>
                    <div class="skeleton-text"></div>
                </div>
            `;
        }
    }
    
    showError(container, message) {
        if (container) {
            container.innerHTML = `
                <div class="error-state">
                    <p class="error-message">${message}</p>
                    <button type="button" class="btn btn-outline retry-btn" data-action="retry">重试</button>
                </div>
            `;
        }
    }
    
    setButtonLoading(button, isLoading) {
        const text = button.querySelector('.btn-text');
        const loading = button.querySelector('.btn-loading');
        
        if (text && loading) {
            text.style.display = isLoading ? 'none' : 'inline';
            loading.style.display = isLoading ? 'inline' : 'none';
        }
        
        button.disabled = isLoading;
    }
    
    showFieldError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const errorElement = document.getElementById(fieldId + 'Error');
        
        if (field) {
            field.classList.add('error');
        }
        
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }
    }
    
    clearFormErrors(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        form.querySelectorAll('.form-input').forEach(input => {
            input.classList.remove('error');
        });
        
        form.querySelectorAll('.form-error').forEach(error => {
            error.textContent = '';
            error.style.display = 'none';
        });
    }
    
    showFormError(formId, message) {
        const form = document.getElementById(formId);
        if (form) {
            const errorContainer = form.querySelector('.form-error') || 
                                  form.appendChild(document.createElement('div'));
            errorContainer.className = 'form-error';
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        }
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    async withRetry(fn, context = 'operation') {
        let lastError;
        
        for (let attempt = 1; attempt <= this.retryConfig.maxRetries; attempt++) {
            try {
                return await fn();
            } catch (error) {
                lastError = error;
                
                if (attempt === this.retryConfig.maxRetries) {
                    throw error;
                }
                
                const delay = Math.min(
                    this.retryConfig.baseDelay * Math.pow(2, attempt - 1),
                    this.retryConfig.maxDelay
                );
                
                console.warn(`${context} 尝试 ${attempt} 失败，${delay}ms后重试:`, error.message);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
        
        throw lastError;
    }
    
    handleError(message, error) {
        console.error(message, error);
        showAlert(`${message}: ${error.message}`, 'error');
    }
    
    handleCriticalError(message, error) {
        console.error(message, error);
        showAlert(message, 'error');
        
        // 显示页面级错误状态
        const main = document.querySelector('.dashboard-main');
        if (main) {
            main.innerHTML = `
                <div class="critical-error">
                    <h2>系统暂时不可用</h2>
                    <p>${message}</p>
                    <button type="button" class="btn btn-primary" onclick="location.reload()">刷新页面</button>
                </div>
            `;
        }
    }
    
    cleanup() {
        this.abortController.abort();
    }
}

// 初始化仪表板管理器
let dashboardManager;

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        dashboardManager = new DashboardManager();
    });
} else {
    dashboardManager = new DashboardManager();
}

// 导出全局方法以保持兼容性
window.dashboardManager = dashboardManager;
</script>

{% endblock %}
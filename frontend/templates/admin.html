{% extends "base.html" %}

{% block title %}管理后台 - 宿舍抽签系统{% endblock %}

{% block content %}
<div class="container">
    <h1>管理后台</h1>
    
    <!-- 功能选项卡 -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-content">
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" onclick="showTab('users', event)">用户管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('buildings', event)">建筑管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('rooms', event)">房间管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('allocations', event)">分配管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('statistics', event)">统计报告</button>
            </div>
        </div>
    </div>

    <!-- 用户管理选项卡 -->
    <div id="usersTab" class="tab-content">
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">用户管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="userSearch" class="form-input" placeholder="搜索用户..." style="width: 200px;">
                        <button type="button" class="btn btn-outline" onclick="loadUsers()">搜索</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="showCreateUserModal()">新建用户</button>
                        <label for="userImportFile" class="btn btn-outline">
                            导入用户CSV
                            <input type="file" id="userImportFile" accept=".csv" style="display: none;" onchange="importUsers()">
                        </label>
                    </div>
                </div>
                <div id="usersTable">
                    <!-- 用户表格将通过JavaScript加载 -->
                </div>
                <div id="usersPagination" style="margin-top: 16px;">
                    <!-- 分页将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 建筑管理选项卡 -->
    <div id="buildingsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">建筑管理</h3>
            </div>
            <div class="card-content">
                <div style="margin-bottom: 16px;">
                    <button type="button" class="btn btn-primary" onclick="showCreateBuildingModal()">新增建筑</button>
                </div>
                <div id="buildingsTable">
                    <!-- 建筑表格将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 房间管理选项卡 -->
    <div id="roomsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">房间管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                    <select id="buildingFilter" class="form-input" style="width: 200px;" onchange="loadRooms()">
                        <option value="">所有建筑</option>
                    </select>
                    <select id="roomTypeFilter" class="form-input" style="width: 150px;" onchange="loadRooms()">
                        <option value="">所有类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                    <button type="button" class="btn btn-primary" onclick="showCreateRoomModal()">新增房间</button>
                    <label for="roomImportFile" class="btn btn-outline">
                        批量导入房间CSV
                        <input type="file" id="roomImportFile" accept=".csv" style="display: none;" onchange="importRooms()">
                    </label>
                </div>
                <div id="roomsTable">
                    <!-- 房间表格将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 分配管理选项卡 -->
    <div id="allocationsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">宿舍分配管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h4>分配管理</h4>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-outline" onclick="showQuickLotteryModal()">一键抽签</button>
                        <button type="button" class="btn btn-outline" onclick="showLotteryResultsModal()">查看所有抽签结果</button>
                    </div>
                </div>
                
                <!-- 选项卡切换 -->
                <div style="margin-bottom: 16px;">
                    <button type="button" class="btn btn-primary" id="roomTypeTabBtn" onclick="showAllocationTab('roomType')">寝室类型分配</button>
                    <button type="button" class="btn btn-outline" id="specificRoomTabBtn" onclick="showAllocationTab('specificRoom')">具体宿舍分配</button>
                </div>
                
                <!-- 寝室类型分配选项卡 -->
                <div id="roomTypeAllocationsTab">
                    <div id="roomTypeAllocationsTable">
                        <!-- 寝室类型分配表格将通过JavaScript加载 -->
                    </div>
                    <div id="roomTypeAllocationsPagination" style="margin-top: 16px;">
                        <!-- 分页将通过JavaScript加载 -->
                    </div>
                </div>
                
                <!-- 具体宿舍分配选项卡 -->
                <div id="specificRoomAllocationsTab" style="display: none;">
                    <div id="allocationsTable">
                        <!-- 分配表格将通过JavaScript加载 -->
                    </div>
                    <div id="allocationsPagination" style="margin-top: 16px;">
                        <!-- 分页将通过JavaScript加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增建筑模态框 -->
<div id="createBuildingModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新增建筑</h3>
        </div>
        <div class="modal-content">
            <form id="createBuildingForm">
                <div class="form-group">
                    <label class="form-label">建筑名称</label>
                    <input type="text" id="buildingName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">描述</label>
                    <textarea id="buildingDescription" class="form-input" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateBuildingModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createBuilding()">创建</button>
        </div>
    </div>
</div>

<!-- 新建用户模态框 -->
<div id="createUserModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新建用户</h3>
        </div>
        <div class="modal-content">
            <form id="createUserForm">
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" id="userName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" id="userUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" id="userPassword" class="form-input" required minlength="6">
                    <small class="form-text">密码长度不能少于6位</small>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateUserModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createUser()">创建</button>
        </div>
    </div>
</div>

<!-- 新增房间模态框 -->
<div id="createRoomModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新增房间</h3>
        </div>
        <div class="modal-content">
            <form id="createRoomForm">
                <div class="form-group">
                    <label class="form-label">选择建筑</label>
                    <select id="roomBuildingId" class="form-input" required>
                        <option value="">请选择建筑</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">房间号</label>
                    <input type="text" id="roomNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="roomType" class="form-input" required>
                        <option value="">请选择类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">最大容量</label>
                    <input type="number" id="maxCapacity" class="form-input" required min="1" max="8">
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateRoomModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createRoom()">创建</button>
        </div>
    </div>
</div>


<!-- 一键抽签模态框 -->
<div id="quickLotteryModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">一键抽签</h3>
        </div>
        <div class="modal-content">
            <div class="alert alert-info" style="margin-bottom: 16px; padding: 12px; background-color: #e3f2fd; border-radius: 4px;">
                <strong>说明：</strong>抽签完成后将保存为草稿，您可以在"查看抽签结果"中进行修改，确认无误后再发布。
            </div>
            <form id="quickLotteryForm">
                <div class="form-group">
                    <label class="form-label">抽签名称</label>
                    <input type="text" id="lotteryName" class="form-input" required placeholder="例如：2024年春季宿舍抽签">
                </div>
                <div class="form-group">
                    <label class="form-label">分配模式</label>
                    <select id="allocationMode" class="form-input" onchange="toggleAllocationMode()" required>
                        <option value="">请选择分配模式</option>
                        <option value="single">单一房间类型</option>
                        <option value="mixed">混合房间类型</option>
                    </select>
                </div>
                
                <!-- 单一房间类型模式 -->
                <div id="singleModeOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">房间类型</label>
                        <select id="lotteryRoomType" class="form-input">
                            <option value="">请选择房间类型</option>
                            <option value="4">4人间</option>
                            <option value="8">8人间</option>
                        </select>
                    </div>
                </div>
                
                <!-- 混合房间类型模式 -->
                <div id="mixedModeOptions" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">四人间数量</label>
                        <input type="number" id="room4Count" class="form-input" min="0" value="0" onchange="updateQuickLotteryPreview()">
                        <small class="form-help">四人间可容纳人数: <span id="quick_room4Capacity">0</span></small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">八人间数量</label>
                        <input type="number" id="room8Count" class="form-input" min="0" value="0" onchange="updateQuickLotteryPreview()">
                        <small class="form-help">八人间可容纳人数: <span id="quick_room8Capacity">0</span></small>
                    </div>
                    <div class="form-group">
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 4px;">
                            <div><strong>总床位数:</strong> <span id="quick_totalBeds">0</span></div>
                            <div><strong>参与用户数:</strong> <span id="quick_totalUsers">0</span></div>
                            <div id="quick_allocationWarning" style="color: #d32f2f; margin-top: 8px; display: none;">
                                ⚠️ 床位数不足，部分用户将无法分配
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <p class="form-text">系统将自动为所有非管理员用户生成抽签号码，抽签结果默认保存为草稿状态，您可以选择发布或删除。</p>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideQuickLotteryModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="performQuickLottery(event)">开始抽签</button>
        </div>
    </div>
</div>

<!-- 抽签结果查看模态框 -->
<div id="lotteryResultsModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">抽签结果管理</h3>
        </div>
        <div class="modal-content">
            <div id="lotteryResultsContent">
                <!-- 抽签结果内容将通过JavaScript加载 -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideLotteryResultsModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 编辑房间模态框 -->
<div id="editRoomModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">编辑房间</h3>
        </div>
        <div class="modal-content">
            <form id="editRoomForm">
                <div class="form-group">
                    <label class="form-label">房间号</label>
                    <input type="text" id="editRoomNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="editRoomType" class="form-input" required>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">最大容量</label>
                    <input type="number" id="editMaxCapacity" class="form-input" required min="1" max="8">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="editIsAvailable"> 房间可用
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideEditRoomModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="updateRoom()">保存</button>
        </div>
    </div>
</div>

<!-- 编辑宿舍分配模态框 -->
<div id="editAllocationModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">编辑宿舍分配</h3>
        </div>
        <div class="modal-content">
            <div style="display: flex; gap: 24px;">
                <!-- 左侧：当前分配信息 -->
                <div style="flex: 1;">
                    <h4>当前分配信息</h4>
                    <div id="currentAllocationInfo" style="padding: 12px; background-color: #f5f5f5; border-radius: 4px; margin-bottom: 16px;">
                        <!-- 当前分配信息将通过JavaScript加载 -->
                    </div>
                </div>
                
                <!-- 右侧：新的房间床位选择 -->
                <div style="flex: 1;">
                    <h4>选择新的房间和床位</h4>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">建筑</label>
                        <select id="editAllocationBuildingSelect" class="form-input" style="width: 100%; margin-bottom: 8px;" onchange="loadRoomsForEditAllocation()">
                            <option value="">请选择建筑</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="form-label">房间</label>
                        <select id="editAllocationRoomSelect" class="form-input" style="width: 100%;" onchange="loadBedsForEditAllocation()">
                            <option value="">请选择房间</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">床位</label>
                        <div id="editAllocationBedsTable" style="max-height: 200px; overflow-y: auto;">
                            <!-- 床位表格 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideEditAllocationModal()">取消</button>
            <button type="button" class="btn btn-primary" id="confirmEditAllocationBtn" onclick="confirmEditAllocation()" disabled>确认修改</button>
        </div>
    </div>
</div>

<!-- 编辑抽签房间类型分配模态框 -->
<div id="editLotteryRoomTypeModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">编辑抽签房间类型分配</h3>
        </div>
        <div class="modal-content">
            <div style="margin-bottom: 16px;">
                <strong>学生：</strong><span id="editLotteryUserName"></span>
            </div>
            <form id="editLotteryRoomTypeForm">
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="editLotteryRoomType" class="form-input" required>
                        <option value="">请选择房间类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">备注</label>
                    <textarea id="editLotteryRoomTypeNotes" class="form-input" rows="3" placeholder="可选备注"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideEditLotteryRoomTypeModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="confirmEditLotteryRoomType()">保存</button>
        </div>
    </div>
</div>

<!-- 抽签结果确认模态框 -->
<div id="lotteryConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title">抽签完成</h3>
        </div>
        <div class="modal-content">
            <div id="lotteryConfirmContent">
                <!-- 抽签确认内容将通过JavaScript加载 -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideLotteryConfirmModal()">关闭</button>
            <button type="button" class="btn btn-primary" id="viewEditResultsBtn" onclick="toggleLotteryResultsView()">查看和修改结果</button>
            <button type="button" class="btn btn-success" id="saveDraftBtn" onclick="saveCurrentLotteryDraft()">保存草稿</button>
            <button type="button" class="btn btn-error" id="deleteLotteryBtn" onclick="deleteCurrentLottery()">删除重抽</button>
        </div>
    </div>
</div>

<!-- 统计报告选项卡 -->
<div id="statisticsTab" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">统计报告</h3>
            <div style="display: flex; gap: 16px;">
                <button class="btn btn-success" onclick="exportAllocations()">导出Excel报告</button>
                <button class="btn btn-outline" onclick="refreshStatistics()">刷新数据</button>
            </div>
        </div>
        <div class="card-content">
            <div id="statisticsContent">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- 基础统计卡片 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">用户统计</h4>
                        </div>
                        <div class="card-content">
                            <div class="stat-item">
                                <span class="stat-label">总用户数：</span>
                                <span class="stat-value" id="totalUsers">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">已分配房间类型：</span>
                                <span class="stat-value" id="roomTypeAllocatedUsers">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">未分配房间类型：</span>
                                <span class="stat-value" id="roomTypeUnallocatedUsers">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 房间分配统计 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">房间分配统计</h4>
                        </div>
                        <div class="card-content">
                            <div class="stat-item">
                                <span class="stat-label">已选择具体房间：</span>
                                <span class="stat-value" id="roomAllocatedUsers">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">未选择具体房间：</span>
                                <span class="stat-value" id="roomUnallocatedUsers">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">已确认分配：</span>
                                <span class="stat-value" id="confirmedUsers">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">未确认分配：</span>
                                <span class="stat-value" id="unconfirmedUsers">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 房间类型统计 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">房间类型分布</h4>
                        </div>
                        <div class="card-content">
                            <div class="stat-item">
                                <span class="stat-label">分配到4人间：</span>
                                <span class="stat-value" id="room4Users">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">分配到8人间：</span>
                                <span class="stat-value" id="room8Users">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 床位统计 -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">床位使用情况</h4>
                        </div>
                        <div class="card-content">
                            <div class="stat-item">
                                <span class="stat-label">总床位数：</span>
                                <span class="stat-value" id="totalBeds">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">已占用床位：</span>
                                <span class="stat-value" id="occupiedBeds">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">空闲床位：</span>
                                <span class="stat-value" id="availableBeds">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 房间类型分布图表 -->
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">房间配置统计</h4>
                    </div>
                    <div class="card-content">
                        <div id="roomCountsChart" style="min-height: 200px;">
                            <!-- 房间类型统计将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTab = 'users';
let currentUsersPage = 1;
let currentAllocationsPage = 1;
let currentRoomTypeAllocationsPage = 1;
let buildings = [];
let currentLotteryId = null;
let selectedUserId = null;
let selectedUserName = '';
let selectedBedId = null;
let selectedRoomTypeUserId = null;
let selectedRoomTypeUserName = '';
let currentAllocationTab = 'roomType';
let currentEditLotteryResultId = null;
let currentEditingRoomId = null;
let currentEditAllocationId = null;
let selectedEditBedId = null;
let isResultsViewVisible = false;

document.addEventListener('DOMContentLoaded', async function() {
    if (!(await requireAdmin())) return;
    
    showTab('users');
});

function showTab(tabName, event) {
    // 隐藏所有选项卡
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // 更新按钮状态
    document.querySelectorAll('.card-content button').forEach(btn => {
        btn.className = 'btn btn-outline';
    });
    
    // 显示选中的选项卡
    document.getElementById(tabName + 'Tab').style.display = 'block';
    
    // 如果有event，更新按钮样式
    if (event && event.target) {
        event.target.className = 'btn btn-primary';
    }
    
    currentTab = tabName;
    
    // 加载对应数据
    switch(tabName) {
        case 'users':
            loadUsers();
            break;
        case 'buildings':
            loadBuildings();
            break;
        case 'rooms':
            loadBuildingsForFilter();
            loadRooms();
            break;
        case 'allocations':
            loadRoomTypeAllocations();
            break;
        case 'statistics':
            loadStatistics();
            break;
    }
}

// 用户管理相关函数
async function loadUsers() {
    const search = document.getElementById('userSearch').value;
    
    try {
        const response = await api.getUsers(currentUsersPage, 20, search);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>角色</th>
                        <th>注册时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>${user.is_admin ? '管理员' : '普通用户'}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                ${!user.is_admin ? `
                                    <button class="btn btn-outline" style="margin-right: 8px;" onclick="resetPassword(${user.id})">重置密码</button>
                                    <button class="btn btn-error" onclick="deleteUser(${user.id})">删除</button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('usersTable').innerHTML = table;
        
        // 更新分页
        updateUsersPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function importUsers() {
    const fileInput = document.getElementById('userImportFile');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    try {
        const response = await api.importUsers(file);
        showAlert(`导入完成：成功 ${response.success_count} 个，失败 ${response.error_count} 个`, 'success');
        
        if (response.errors && response.errors.length > 0) {
            showAlert(`错误信息：${response.errors.join('; ')}`, 'warning');
        }
        
        // 切换到用户管理选项卡
        showTab('users');
        
        // 重置搜索条件和页码，确保能看到新用户
        document.getElementById('userSearch').value = '';
        currentUsersPage = 1;
        
        // 重新加载用户列表
        loadUsers();
        fileInput.value = '';
    } catch (error) {
        showAlert(error.message, 'error');
        fileInput.value = '';
    }
}

async function deleteUser(userId) {
    if (!confirm('确定要删除此用户吗？')) return;
    
    try {
        await api.deleteUser(userId);
        showAlert('用户删除成功', 'success');
        loadUsers();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function resetPassword(userId) {
    const newPassword = prompt('请输入新密码（至少6位）：');
    if (!newPassword || newPassword.length < 6) {
        showAlert('密码长度不能少于6位', 'error');
        return;
    }
    
    try {
        await api.resetUserPassword(userId, newPassword);
        showAlert('密码重置成功', 'success');
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateUsersPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changePage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changePage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('usersPagination').innerHTML = paginationHtml;
}

function changePage(page) {
    currentUsersPage = page;
    loadUsers();
}

// 用户创建相关函数
function showCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'flex';
}

function hideCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'none';
    document.getElementById('createUserForm').reset();
}

async function createUser() {
    const name = document.getElementById('userName').value.trim();
    const username = document.getElementById('userUsername').value.trim();
    const password = document.getElementById('userPassword').value;
    
    if (!name || !username || !password) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAlert('密码长度不能少于6位', 'error');
        return;
    }
    
    try {
        await api.createUser({ name, username, password });
        showAlert('用户创建成功', 'success');
        hideCreateUserModal();
        
        // 切换到用户管理选项卡并重置搜索
        showTab('users');
        document.getElementById('userSearch').value = '';
        currentUsersPage = 1;
        loadUsers();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 建筑管理相关函数
async function loadBuildings() {
    try {
        const response = await api.getBuildings();
        buildings = response.buildings;
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>建筑名称</th>
                        <th>描述</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${buildings.map(building => `
                        <tr>
                            <td>${building.name}</td>
                            <td>${building.description || ''}</td>
                            <td>${formatDate(building.created_at)}</td>
                            <td>
                                <button class="btn btn-error btn-sm" onclick="deleteBuilding(${building.id})">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('buildingsTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showCreateBuildingModal() {
    document.getElementById('createBuildingModal').style.display = 'flex';
}

function hideCreateBuildingModal() {
    document.getElementById('createBuildingModal').style.display = 'none';
    document.getElementById('createBuildingForm').reset();
}

async function createBuilding() {
    const name = document.getElementById('buildingName').value;
    const description = document.getElementById('buildingDescription').value;
    
    if (!name) {
        showAlert('建筑名称不能为空', 'error');
        return;
    }
    
    try {
        await api.createBuilding({ name, description });
        showAlert('建筑创建成功', 'success');
        hideCreateBuildingModal();
        loadBuildings();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteBuilding(buildingId) {
    if (!confirm('确定要删除此建筑吗？删除前请确保该建筑下没有房间。')) return;
    
    try {
        await api.deleteBuilding(buildingId);
        showAlert('建筑删除成功', 'success');
        loadBuildings();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 房间管理相关函数

function editRoom(roomId, roomNumber, roomType, maxCapacity, isAvailable) {
    currentEditingRoomId = roomId;
    
    document.getElementById('editRoomNumber').value = roomNumber;
    document.getElementById('editRoomType').value = roomType;
    document.getElementById('editMaxCapacity').value = maxCapacity;
    document.getElementById('editIsAvailable').checked = isAvailable;
    
    document.getElementById('editRoomModal').style.display = 'flex';
}

function hideEditRoomModal() {
    document.getElementById('editRoomModal').style.display = 'none';
    document.getElementById('editRoomForm').reset();
    currentEditingRoomId = null;
}

async function updateRoom() {
    if (!currentEditingRoomId) return;
    
    const roomNumber = document.getElementById('editRoomNumber').value.trim();
    const roomType = document.getElementById('editRoomType').value;
    const maxCapacity = parseInt(document.getElementById('editMaxCapacity').value);
    const isAvailable = document.getElementById('editIsAvailable').checked;
    
    if (!roomNumber || !roomType || !maxCapacity) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    try {
        await api.updateRoom(currentEditingRoomId, {
            room_number: roomNumber,
            room_type: roomType,
            max_capacity: maxCapacity,
            is_available: isAvailable
        });
        showAlert('房间更新成功', 'success');
        hideEditRoomModal();
        loadRooms();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteRoom(roomId, roomInfo) {
    if (!confirm(`确定要删除房间 ${roomInfo} 吗？删除前请确保该房间没有学生入住。`)) return;
    
    try {
        await api.deleteRoom(roomId);
        showAlert('房间删除成功', 'success');
        loadRooms();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}
async function loadBuildingsForFilter() {
    try {
        const response = await api.getBuildings();
        buildings = response.buildings;
        
        const buildingSelect = document.getElementById('buildingFilter');
        const roomBuildingSelect = document.getElementById('roomBuildingId');
        
        const options = buildings.map(building => 
            `<option value="${building.id}">${building.name}</option>`
        ).join('');
        
        buildingSelect.innerHTML = '<option value="">所有建筑</option>' + options;
        roomBuildingSelect.innerHTML = '<option value="">请选择建筑</option>' + options;
    } catch (error) {
        console.error('加载建筑列表失败:', error);
    }
}

async function loadRooms() {
    const buildingId = document.getElementById('buildingFilter').value;
    const roomType = document.getElementById('roomTypeFilter').value;
    
    try {
        const response = await api.getRooms(buildingId || null, roomType || null);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>建筑</th>
                        <th>房间号</th>
                        <th>类型</th>
                        <th>容量</th>
                        <th>当前入住</th>
                        <th>状态</th>
                        <th>可用床位</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.rooms.map(room => `
                        <tr>
                            <td>${room.building_name}</td>
                            <td>${room.room_number}</td>
                            <td>${room.room_type}人间</td>
                            <td>${room.max_capacity}</td>
                            <td>${room.current_occupancy}</td>
                            <td>${room.is_available ? '可用' : '不可用'}</td>
                            <td>${room.available_beds}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" style="margin-right: 8px;" onclick="editRoom(${room.id}, '${room.room_number}', '${room.room_type}', ${room.max_capacity}, ${room.is_available})">编辑</button>
                                <button class="btn btn-error btn-sm" onclick="deleteRoom(${room.id}, '${room.building_name}-${room.room_number}')">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('roomsTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'flex';
}

function hideCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'none';
    document.getElementById('createRoomForm').reset();
}

async function createRoom() {
    const buildingId = document.getElementById('roomBuildingId').value;
    const roomNumber = document.getElementById('roomNumber').value;
    const roomType = document.getElementById('roomType').value;
    const maxCapacity = document.getElementById('maxCapacity').value;
    
    if (!buildingId || !roomNumber || !roomType || !maxCapacity) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    try {
        await api.createRoom({
            building_id: parseInt(buildingId),
            room_number: roomNumber,
            room_type: roomType,
            max_capacity: parseInt(maxCapacity)
        });
        showAlert('房间创建成功', 'success');
        hideCreateRoomModal();
        
        // 切换到房间管理选项卡并重置筛选
        showTab('rooms');
        document.getElementById('buildingFilter').value = '';
        document.getElementById('roomTypeFilter').value = '';
        loadRooms();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function importRooms() {
    const fileInput = document.getElementById('roomImportFile');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    try {
        const response = await api.importRooms(file);
        showAlert(`房间导入完成：新增 ${response.created_count} 个房间，跳过 ${response.skipped_count} 个房间`, 'success');
        
        if (response.errors.length > 0) {
            showAlert(`错误信息：${response.errors.join('; ')}`, 'warning');
        }
        
        // 切换到房间管理选项卡
        showTab('rooms');
        
        // 重置筛选条件，确保能看到新房间
        document.getElementById('buildingFilter').value = '';
        document.getElementById('roomTypeFilter').value = '';
        
        // 重新加载房间列表
        loadRooms();
        fileInput.value = '';
    } catch (error) {
        showAlert(error.message, 'error');
        fileInput.value = '';
    }
}

// 分配管理相关函数
function showAllocationTab(tabName) {
    // 更新按钮状态
    document.getElementById('roomTypeTabBtn').className = 'btn btn-outline';
    document.getElementById('specificRoomTabBtn').className = 'btn btn-outline';
    
    // 隐藏所有选项卡
    document.getElementById('roomTypeAllocationsTab').style.display = 'none';
    document.getElementById('specificRoomAllocationsTab').style.display = 'none';
    
    // 显示选中的选项卡
    if (tabName === 'roomType') {
        document.getElementById('roomTypeTabBtn').className = 'btn btn-primary';
        document.getElementById('roomTypeAllocationsTab').style.display = 'block';
        loadRoomTypeAllocations();
    } else {
        document.getElementById('specificRoomTabBtn').className = 'btn btn-primary';
        document.getElementById('specificRoomAllocationsTab').style.display = 'block';
        loadAllocations();
    }
    
    currentAllocationTab = tabName;
}

async function loadRoomTypeAllocations() {
    try {
        const response = await api.getRoomTypeAllocations(currentRoomTypeAllocationsPage, 20);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>用户名</th>
                        <th>寝室类型</th>
                        <th>分配方式</th>
                        <th>分配时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.allocations.map(allocation => `
                        <tr>
                            <td>${allocation.user_name}</td>
                            <td>${allocation.user_username}</td>
                            <td>${allocation.room_type ? allocation.room_type + '人间' : '未分配'}</td>
                            <td>${allocation.allocator_name || '系统'}</td>
                            <td>${formatDate(allocation.allocated_at)}</td>
                            <td>
                                ${allocation.allocation_type === 'manual' ? `
                                    <button class="btn btn-outline btn-sm" style="margin-right: 8px;" onclick="editRoomTypeAllocation(${allocation.id}, '${allocation.room_type || ''}', '${allocation.notes ? allocation.notes : ''}')">编辑</button>
                                    <button class="btn btn-error btn-sm" onclick="deleteRoomTypeAllocation(${allocation.id})">删除</button>
                                ` : `
                                    <button class="btn btn-outline btn-sm" style="margin-right: 8px;" onclick="editLotteryRoomTypeAllocation(${allocation.id}, '${allocation.room_type || ''}', '${allocation.user_name}')">编辑</button>
                                    <span class="text-muted">抽签分配</span>
                                `}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('roomTypeAllocationsTable').innerHTML = table;
        
        // 更新分页
        updateRoomTypeAllocationsPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateRoomTypeAllocationsPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeRoomTypeAllocationsPage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeRoomTypeAllocationsPage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('roomTypeAllocationsPagination').innerHTML = paginationHtml;
}

function changeRoomTypeAllocationsPage(page) {
    currentRoomTypeAllocationsPage = page;
    loadRoomTypeAllocations();
}

async function loadAllocations() {
    try {
        const response = await api.getAllocations(currentAllocationsPage, 20);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>建筑</th>
                        <th>房间号</th>
                        <th>床位号</th>
                        <th>选择时间</th>
                        <th>确认状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.allocations.map(allocation => `
                        <tr>
                            <td>${allocation.user_name}</td>
                            <td>${allocation.building_name}</td>
                            <td>${allocation.room_number}</td>
                            <td>${allocation.bed_number}</td>
                            <td>${formatDate(allocation.selected_at)}</td>
                            <td>${allocation.is_confirmed ? '已确认' : '未确认'}</td>
                            <td>
                                <button class="btn btn-outline" style="margin-right: 8px;" onclick="editAllocation(${allocation.id})">编辑</button>
                                <button class="btn btn-error" onclick="deleteAllocation(${allocation.id})">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('allocationsTable').innerHTML = table;
        
        // 更新分页
        updateAllocationsPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteAllocation(allocationId) {
    if (!confirm('确定要删除此分配吗？')) return;
    
    try {
        await api.deleteAllocation(allocationId);
        showAlert('分配删除成功', 'success');
        loadAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 编辑分配相关函数

async function editAllocation(allocationId) {
    currentEditAllocationId = allocationId;
    selectedEditBedId = null;
    
    try {
        // 获取当前分配详情
        const response = await api.getAllocations(1, 1000); // 获取所有分配来找到指定的分配
        const allocation = response.allocations.find(a => a.id === allocationId);
        
        if (!allocation) {
            showAlert('分配记录不存在', 'error');
            return;
        }
        
        // 显示当前分配信息
        document.getElementById('currentAllocationInfo').innerHTML = `
            <div><strong>学生：</strong>${allocation.user_name}</div>
            <div><strong>当前宿舍：</strong>${allocation.building_name} ${allocation.room_number}室 ${allocation.bed_number}号床</div>
            <div><strong>确认状态：</strong>${allocation.is_confirmed ? '已确认' : '未确认'}</div>
        `;
        
        // 重置选择
        resetEditAllocationSelection();
        
        // 加载建筑列表
        await loadBuildingsForEditAllocation();
        
        // 显示模态框
        document.getElementById('editAllocationModal').style.display = 'flex';
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function hideEditAllocationModal() {
    document.getElementById('editAllocationModal').style.display = 'none';
    resetEditAllocationSelection();
}

function resetEditAllocationSelection() {
    selectedEditBedId = null;
    document.getElementById('editAllocationBuildingSelect').value = '';
    document.getElementById('editAllocationRoomSelect').innerHTML = '<option value="">请选择房间</option>';
    document.getElementById('editAllocationBedsTable').innerHTML = '';
    document.getElementById('confirmEditAllocationBtn').disabled = true;
}

async function loadBuildingsForEditAllocation() {
    try {
        const response = await api.getBuildings();
        const select = document.getElementById('editAllocationBuildingSelect');
        
        select.innerHTML = '<option value="">请选择建筑</option>';
        response.buildings.forEach(building => {
            select.innerHTML += `<option value="${building.id}">${building.name}</option>`;
        });
    } catch (error) {
        showAlert('获取建筑列表失败', 'error');
    }
}

async function loadRoomsForEditAllocation() {
    const buildingId = document.getElementById('editAllocationBuildingSelect').value;
    const roomSelect = document.getElementById('editAllocationRoomSelect');
    
    if (!buildingId) {
        roomSelect.innerHTML = '<option value="">请选择房间</option>';
        document.getElementById('editAllocationBedsTable').innerHTML = '';
        return;
    }
    
    try {
        // 获取该建筑的所有房间
        const response = await api.getRooms(buildingId);
        
        roomSelect.innerHTML = '<option value="">请选择房间</option>';
        response.rooms.forEach(room => {
            if (room.available_beds > 0) { // 只显示有空余床位的房间
                roomSelect.innerHTML += `<option value="${room.id}">${room.room_number}室 (${room.room_type}人间, ${room.available_beds}个空床位)</option>`;
            }
        });
    } catch (error) {
        showAlert('获取房间列表失败', 'error');
    }
}

async function loadBedsForEditAllocation() {
    const roomId = document.getElementById('editAllocationRoomSelect').value;
    const bedsTable = document.getElementById('editAllocationBedsTable');
    
    if (!roomId) {
        bedsTable.innerHTML = '';
        return;
    }
    
    try {
        // 获取房间详情包括床位信息
        const response = await api.get(`/api/admin/rooms/${roomId}`);
        const room = response.room;
        
        if (!room.beds || room.beds.length === 0) {
            bedsTable.innerHTML = '<p>该房间没有床位信息</p>';
            return;
        }
        
        // 只显示空余的床位
        const availableBeds = room.beds.filter(bed => !bed.is_occupied);
        
        if (availableBeds.length === 0) {
            bedsTable.innerHTML = '<p>该房间没有空余床位</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>床位号</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${availableBeds.map(bed => `
                        <tr>
                            <td>${bed.bed_number}号床</td>
                            <td>空闲</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="selectEditBed(${bed.id}, '${bed.bed_number}', event)">选择</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        bedsTable.innerHTML = table;
    } catch (error) {
        showAlert('获取床位信息失败', 'error');
    }
}

function selectEditBed(bedId, bedNumber, event) {
    selectedEditBedId = bedId;
    
    // 更新按钮状态
    const buttons = document.querySelectorAll('#editAllocationBedsTable .btn-primary');
    buttons.forEach(btn => {
        btn.textContent = '选择';
        btn.className = 'btn btn-primary btn-sm';
    });
    
    // 高亮选中的床位
    if (event && event.target) {
        event.target.textContent = '已选择';
        event.target.className = 'btn btn-success btn-sm';
    }
    
    // 启用确认按钮
    document.getElementById('confirmEditAllocationBtn').disabled = false;
}

async function confirmEditAllocation() {
    if (!selectedEditBedId) {
        showAlert('请选择床位', 'error');
        return;
    }
    
    try {
        const response = await api.updateAllocation(currentEditAllocationId, {
            bed_id: selectedEditBedId
        });
        
        showAlert('宿舍分配修改成功', 'success');
        hideEditAllocationModal();
        loadAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateAllocationsPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeAllocationsPage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeAllocationsPage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('allocationsPagination').innerHTML = paginationHtml;
}

function changeAllocationsPage(page) {
    currentAllocationsPage = page;
    loadAllocations();
}

// 手动分配相关函数
function showManualAllocationModal() {
    document.getElementById('manualAllocationModal').style.display = 'flex';
    loadUnallocatedUsers();
    loadBuildingsForAllocation();
    resetAllocationSelection();
}

function hideManualAllocationModal() {
    document.getElementById('manualAllocationModal').style.display = 'none';
    resetAllocationSelection();
}

function resetAllocationSelection() {
    selectedUserId = null;
    selectedUserName = '';
    selectedBedId = null;
    document.getElementById('selectedUserInfo').style.display = 'none';
    document.getElementById('allocationBuildingSelect').value = '';
    document.getElementById('allocationRoomSelect').innerHTML = '<option value="">请选择房间</option>';
    document.getElementById('bedsTable').innerHTML = '';
    document.getElementById('confirmAllocationBtn').disabled = true;
    document.getElementById('unallocatedUserSearch').value = '';
}

async function loadUnallocatedUsers() {
    const search = document.getElementById('unallocatedUserSearch').value;
    
    try {
        const response = await api.getUnallocatedUsers(1, 50, search);
        
        if (!response.users || response.users.length === 0) {
            document.getElementById('unallocatedUsersTable').innerHTML = '<p>暂无未分配用户</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr ${selectedUserId === user.id ? 'style=\"background-color: #e3f2fd;\"' : ''}>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectUserForAllocation(${user.id}, '${user.name}')">
                                    ${selectedUserId === user.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('unallocatedUsersTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('unallocatedUsersTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectUserForAllocation(userId, userName) {
    selectedUserId = userId;
    selectedUserName = userName;
    document.getElementById('selectedUserName').textContent = userName;
    document.getElementById('selectedUserInfo').style.display = 'block';
    loadUnallocatedUsers(); // 重新加载以更新选择状态
    updateConfirmButton();
}

async function loadBuildingsForAllocation() {
    try {
        const response = await api.getBuildings();
        const select = document.getElementById('allocationBuildingSelect');
        
        const options = response.buildings.map(building => 
            `<option value="${building.id}">${building.name}</option>`
        ).join('');
        
        select.innerHTML = '<option value="">请选择建筑</option>' + options;
    } catch (error) {
        console.error('加载建筑列表失败:', error);
    }
}

async function loadRoomsForAllocation() {
    const buildingId = document.getElementById('allocationBuildingSelect').value;
    const roomSelect = document.getElementById('allocationRoomSelect');
    
    if (!buildingId) {
        roomSelect.innerHTML = '<option value="">请选择房间</option>';
        document.getElementById('bedsTable').innerHTML = '';
        return;
    }
    
    try {
        const response = await api.getRooms(buildingId);
        
        const availableRooms = response.rooms.filter(room => room.available_beds > 0);
        
        const options = availableRooms.map(room => 
            `<option value="${room.id}">${room.room_number} (${room.room_type}人间, 剩余${room.available_beds}个床位)</option>`
        ).join('');
        
        roomSelect.innerHTML = '<option value="">请选择房间</option>' + options;
        document.getElementById('bedsTable').innerHTML = '';
    } catch (error) {
        console.error('加载房间列表失败:', error);
    }
}

async function loadBedsForAllocation() {
    const roomId = document.getElementById('allocationRoomSelect').value;
    
    if (!roomId) {
        document.getElementById('bedsTable').innerHTML = '';
        return;
    }
    
    try {
        const response = await api.getRooms();
        const room = response.rooms.find(r => r.id === parseInt(roomId));
        
        if (!room || !room.beds) {
            document.getElementById('bedsTable').innerHTML = '<p>暂无床位信息</p>';
            return;
        }
        
        const availableBeds = room.beds.filter(bed => !bed.is_occupied);
        
        if (availableBeds.length === 0) {
            document.getElementById('bedsTable').innerHTML = '<p>该房间暂无可用床位</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>床位号</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${availableBeds.map(bed => `
                        <tr ${selectedBedId === bed.id ? 'style=\"background-color: #e8f5e8;\"' : ''}>
                            <td>${bed.bed_number}</td>
                            <td>可用</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectBedForAllocation(${bed.id})">
                                    ${selectedBedId === bed.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('bedsTable').innerHTML = table;
    } catch (error) {
        console.error('加载床位列表失败:', error);
        document.getElementById('bedsTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectBedForAllocation(bedId) {
    selectedBedId = bedId;
    loadBedsForAllocation(); // 重新加载以更新选择状态
    updateConfirmButton();
}

function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmAllocationBtn');
    confirmBtn.disabled = !(selectedUserId && selectedBedId);
}

async function confirmManualAllocation() {
    if (!selectedUserId || !selectedBedId) {
        showAlert('请选择用户和床位', 'error');
        return;
    }
    
    const roomId = document.getElementById('allocationRoomSelect').value;
    
    if (!roomId) {
        showAlert('请选择房间', 'error');
        return;
    }
    
    try {
        const response = await api.createAllocation({
            user_id: selectedUserId,
            room_id: parseInt(roomId),
            bed_id: selectedBedId
        });
        
        showAlert(response.message, 'success');
        hideManualAllocationModal();
        loadAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 模态框事件处理
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});

// 专门为编辑房间模态框添加点击关闭事件
document.getElementById('editRoomModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideEditRoomModal();
    }
});

// 房间类型和容量联动
document.getElementById('roomType').addEventListener('change', function() {
    const maxCapacityInput = document.getElementById('maxCapacity');
    const value = this.value;
    
    if (value === '4') {
        maxCapacityInput.value = '4';
    } else if (value === '8') {
        maxCapacityInput.value = '8';
    }
});

// 编辑房间的房间类型和容量联动
document.getElementById('editRoomType').addEventListener('change', function() {
    const maxCapacityInput = document.getElementById('editMaxCapacity');
    const value = this.value;
    
    if (value === '4') {
        maxCapacityInput.value = '4';
    } else if (value === '8') {
        maxCapacityInput.value = '8';
    }
});

// 寝室类型分配相关函数
function showRoomTypeAllocationModal() {
    document.getElementById('roomTypeAllocationModal').style.display = 'flex';
    loadUnallocatedRoomTypeUsers();
    resetRoomTypeAllocationSelection();
}

function hideRoomTypeAllocationModal() {
    document.getElementById('roomTypeAllocationModal').style.display = 'none';
    resetRoomTypeAllocationSelection();
}

function resetRoomTypeAllocationSelection() {
    selectedRoomTypeUserId = null;
    selectedRoomTypeUserName = '';
    document.getElementById('selectedRoomTypeUserInfo').style.display = 'none';
    document.getElementById('roomTypeSelect').value = '';
    document.getElementById('roomTypeNotes').value = '';
    document.getElementById('confirmRoomTypeAllocationBtn').disabled = true;
    document.getElementById('unallocatedRoomTypeUserSearch').value = '';
}

async function loadUnallocatedRoomTypeUsers() {
    const search = document.getElementById('unallocatedRoomTypeUserSearch').value;
    
    try {
        const response = await api.getUnallocatedRoomTypeUsers(1, 50, search);
        
        if (!response.users || response.users.length === 0) {
            document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = '<p>暂无未分配寝室类型用户</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr ${selectedRoomTypeUserId === user.id ? 'style=\"background-color: #e3f2fd;\"' : ''}>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectUserForRoomType(${user.id}, '${user.name}')">
                                    ${selectedRoomTypeUserId === user.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectUserForRoomType(userId, userName) {
    selectedRoomTypeUserId = userId;
    selectedRoomTypeUserName = userName;
    document.getElementById('selectedRoomTypeUserName').textContent = userName;
    document.getElementById('selectedRoomTypeUserInfo').style.display = 'block';
    loadUnallocatedRoomTypeUsers(); // 重新加载以更新选择状态
    updateRoomTypeConfirmButton();
}

function updateRoomTypeConfirmButton() {
    const roomType = document.getElementById('roomTypeSelect').value;
    const confirmBtn = document.getElementById('confirmRoomTypeAllocationBtn');
    confirmBtn.disabled = !(selectedRoomTypeUserId && roomType);
}

// 添加事件监听器
document.getElementById('roomTypeSelect').addEventListener('change', updateRoomTypeConfirmButton);

async function confirmRoomTypeAllocation() {
    if (!selectedRoomTypeUserId) {
        showAlert('请选择用户', 'error');
        return;
    }
    
    const roomType = document.getElementById('roomTypeSelect').value;
    const notes = document.getElementById('roomTypeNotes').value;
    
    if (!roomType) {
        showAlert('请选择寝室类型', 'error');
        return;
    }
    
    try {
        const response = await api.createRoomTypeAllocation({
            user_id: selectedRoomTypeUserId,
            room_type: roomType,
            notes: notes
        });
        
        showAlert(response.message, 'success');
        hideRoomTypeAllocationModal();
        loadRoomTypeAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function editRoomTypeAllocation(allocationId, currentRoomType, currentNotes) {
    const newRoomType = prompt('请选择新的寝室类型 (4 或 8):', currentRoomType);
    if (!newRoomType || !['4', '8'].includes(newRoomType)) {
        showAlert('寝室类型只能是4或8', 'error');
        return;
    }
    
    const newNotes = prompt('备注:', currentNotes || '');
    
    try {
        const response = await api.updateRoomTypeAllocation(allocationId, {
            room_type: newRoomType,
            notes: newNotes || ''
        });
        
        showAlert(response.message, 'success');
        loadRoomTypeAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteRoomTypeAllocation(allocationId) {
    if (!confirm('确定要删除此寝室类型分配吗？')) return;
    
    try {
        const response = await api.deleteRoomTypeAllocation(allocationId);
        showAlert(response.message, 'success');
        loadRoomTypeAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 抽签管理相关函数
function toggleAllocationMode() {
    const mode = document.getElementById('allocationMode').value;
    const singleModeOptions = document.getElementById('singleModeOptions');
    const mixedModeOptions = document.getElementById('mixedModeOptions');
    
    if (mode === 'single') {
        singleModeOptions.style.display = 'block';
        mixedModeOptions.style.display = 'none';
    } else if (mode === 'mixed') {
        singleModeOptions.style.display = 'none';
        mixedModeOptions.style.display = 'block';
        updateQuickLotteryPreview();
    } else {
        singleModeOptions.style.display = 'none';
        mixedModeOptions.style.display = 'none';
    }
}

async function updateQuickLotteryPreview() {
    const room4Count = parseInt(document.getElementById('room4Count').value) || 0;
    const room8Count = parseInt(document.getElementById('room8Count').value) || 0;
    
    const room4Capacity = room4Count * 4;
    const room8Capacity = room8Count * 8;
    const totalBeds = room4Capacity + room8Capacity;
    
    document.getElementById('quick_room4Capacity').textContent = room4Capacity;
    document.getElementById('quick_room8Capacity').textContent = room8Capacity;
    document.getElementById('quick_totalBeds').textContent = totalBeds;
    
    try {
        // 获取参与用户数
        const response = await api.getUsers(1, 1000); // 获取所有用户
        const nonAdminUsers = response.users.filter(user => !user.is_admin);
        const totalUsers = nonAdminUsers.length;
        
        document.getElementById('quick_totalUsers').textContent = totalUsers;
        
        const warning = document.getElementById('quick_allocationWarning');
        if (totalBeds < totalUsers && totalBeds > 0) {
            warning.style.display = 'block';
            warning.textContent = `⚠️ 床位数不足，将有 ${totalUsers - totalBeds} 名用户无法分配`;
        } else {
            warning.style.display = 'none';
        }
    } catch (error) {
        console.error('获取用户信息失败:', error);
    }
}

function showQuickLotteryModal() {
    document.getElementById('quickLotteryModal').style.display = 'flex';
}

function hideQuickLotteryModal() {
    document.getElementById('quickLotteryModal').style.display = 'none';
    document.getElementById('quickLotteryForm').reset();
}

async function performQuickLottery(event) {
    const lotteryName = document.getElementById('lotteryName').value.trim();
    const allocationMode = document.getElementById('allocationMode').value;
    
    if (!lotteryName || !allocationMode) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    const lotteryData = {
        lottery_name: lotteryName
    };
    
    if (allocationMode === 'single') {
        const roomType = document.getElementById('lotteryRoomType').value;
        if (!roomType) {
            showAlert('请选择房间类型', 'error');
            return;
        }
        lotteryData.room_type = roomType;
    } else if (allocationMode === 'mixed') {
        const room4Count = parseInt(document.getElementById('room4Count').value) || 0;
        const room8Count = parseInt(document.getElementById('room8Count').value) || 0;
        
        if (room4Count === 0 && room8Count === 0) {
            showAlert('四人间和八人间数量不能都为0', 'error');
            return;
        }
        
        lotteryData.room_type = 'mixed';
        lotteryData.room_4_count = room4Count;
        lotteryData.room_6_count = room8Count;
    }
    
    const button = event.target;
    const hideLoading = showLoading(button);
    
    try {
        const response = await api.quickLotteryDraw(lotteryData);
        
        hideQuickLotteryModal();
        showAlert(response.message, 'success');
        
        // 显示抽签结果确认对话框
        currentLotteryId = response.lottery_id;
        showLotteryConfirmDialog(response);
        
    } catch (error) {
        showAlert(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function showLotteryConfirmDialog(lotteryData) {
    let roomTypeInfo = '';
    if (lotteryData.room_4_users && lotteryData.room_8_users) {
        roomTypeInfo = `混合类型 (${lotteryData.room_4_users}人分配四人间, ${lotteryData.room_8_users}人分配八人间)`;
    } else if (lotteryData.room_4_users) {
        roomTypeInfo = `四人间 (${lotteryData.room_4_users}人)`;
    } else if (lotteryData.room_8_users) {
        roomTypeInfo = `八人间 (${lotteryData.room_8_users}人)`;
    } else if (lotteryData.room_type) {
        roomTypeInfo = `${lotteryData.room_type}人间`;
    } else {
        roomTypeInfo = '未指定';
    }
    
    const content = `
        <div id="lotteryBasicInfo" style="margin-bottom: 16px;">
            <p><strong>抽签名称：</strong>${lotteryData.lottery_name || '未知抽签'}</p>
            <p><strong>分配方式：</strong>${roomTypeInfo}</p>
            <p><strong>参与人数：</strong>${lotteryData.total_participants || 0}人</p>
            <p><strong>已分配人数：</strong>${lotteryData.allocated_participants || 0}人</p>
        </div>
        <div class="alert alert-warning" style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 12px; border-radius: 4px;">
            <p><strong>抽签已完成！</strong>结果已保存为草稿状态。</p>
            <ul style="margin-bottom: 0;">
                <li><strong>查看和修改结果：</strong>查看详细抽签结果，可以修改房间类型分配</li>
                <li><strong>保存草稿：</strong>保存当前结果，稍后在"查看所有抽签结果"中发布</li>
                <li><strong>删除重抽：</strong>如果对结果不满意，可以删除并重新抽签</li>
            </ul>
        </div>
        <div id="lotteryResultsSection" style="display: none; margin-top: 24px;">
            <h4>抽签结果详情</h4>
            <div id="lotteryResultsTable">
                <!-- 抽签结果表格将通过JavaScript加载 -->
            </div>
        </div>
    `;
    
    document.getElementById('lotteryConfirmContent').innerHTML = content;
    document.getElementById('lotteryConfirmModal').style.display = 'flex';
}

function hideLotteryConfirmModal() {
    document.getElementById('lotteryConfirmModal').style.display = 'none';
    currentLotteryId = null;
    
    // 重置视图状态
    isResultsViewVisible = false;
    const resultsSection = document.getElementById('lotteryResultsSection');
    const toggleBtn = document.getElementById('viewEditResultsBtn');
    if (resultsSection) resultsSection.style.display = 'none';
    if (toggleBtn) toggleBtn.textContent = '查看和修改结果';
}

async function toggleLotteryResultsView() {
    const resultsSection = document.getElementById('lotteryResultsSection');
    const toggleBtn = document.getElementById('viewEditResultsBtn');
    
    if (!isResultsViewVisible) {
        // 显示结果
        resultsSection.style.display = 'block';
        toggleBtn.textContent = '隐藏结果';
        isResultsViewVisible = true;
        
        // 加载抽签结果
        await loadCurrentLotteryResults();
    } else {
        // 隐藏结果
        resultsSection.style.display = 'none';
        toggleBtn.textContent = '查看和修改结果';
        isResultsViewVisible = false;
    }
}

async function loadCurrentLotteryResults() {
    if (!currentLotteryId) return;
    
    try {
        const response = await api.getAllLotteryResults(1, 1000, currentLotteryId);
        
        if (!response.results || response.results.length === 0) {
            document.getElementById('lotteryResultsTable').innerHTML = '<p>暂无抽签结果</p>';
            return;
        }
        
        const results = response.results.sort((a, b) => a.lottery_number - b.lottery_number);
        
        const table = `
            <div style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>抽签号</th>
                            <th>姓名</th>
                            <th>用户名</th>
                            <th>分配房间类型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results.map(result => `
                            <tr>
                                <td><strong>${result.lottery_number}</strong></td>
                                <td>${result.user_name}</td>
                                <td>${result.user_username || ''}</td>
                                <td>${result.room_type ? `${result.room_type}人间` : '未分配'}</td>
                                <td>
                                    <button class="btn btn-outline btn-sm" onclick="editCurrentLotteryResult(${result.id}, ${result.lottery_number}, '${result.room_type || ''}')">编辑房型</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('lotteryResultsTable').innerHTML = table;
    } catch (error) {
        showAlert('加载抽签结果失败: ' + error.message, 'error');
        document.getElementById('lotteryResultsTable').innerHTML = '<p>加载失败</p>';
    }
}

async function editCurrentLotteryResult(resultId, currentLotteryNumber, currentRoomType) {
    // 只编辑房间类型，不编辑抽签号码
    const roomTypeOptions = `
        <div style="text-align: center;">
            <p style="margin-bottom: 16px;">请选择新的房间类型：</p>
            <select id="tempCurrentRoomTypeSelect" style="padding: 8px; font-size: 16px; width: 150px;">
                <option value="">请选择</option>
                <option value="4" ${currentRoomType === '4' ? 'selected' : ''}>4人间</option>
                <option value="8" ${currentRoomType === '8' ? 'selected' : ''}>8人间</option>
            </select>
        </div>
    `;
    
    // 创建临时的模态框
    const tempModal = document.createElement('div');
    tempModal.className = 'modal-overlay';
    tempModal.style.display = 'flex';
    tempModal.style.zIndex = '1002'; // 确保在抽签确认模态框之上
    tempModal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">编辑抽签结果 - 房间类型</h3>
            </div>
            <div class="modal-content">
                <p><strong>抽签号码：</strong>${currentLotteryNumber}（固定不变）</p>
                ${roomTypeOptions}
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmEditCurrentLotteryRoomType(${resultId})">确认</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(tempModal);
}

async function confirmEditCurrentLotteryRoomType(resultId) {
    const selectElement = document.getElementById('tempCurrentRoomTypeSelect');
    const newRoomType = selectElement.value;
    
    if (!newRoomType) {
        showAlert('请选择房间类型', 'error');
        return;
    }
    
    try {
        // 只更新房间类型，不更新抽签号码
        const updateData = { 
            room_type: newRoomType
        };
        
        await api.updateLotteryResult(resultId, updateData);
        showAlert('房间类型更新成功', 'success');
        
        // 关闭临时模态框
        const tempModal = selectElement.closest('.modal-overlay');
        if (tempModal) {
            tempModal.remove();
        }
        
        // 重新加载当前抽签结果
        await loadCurrentLotteryResults();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function saveCurrentLotteryDraft() {
    if (!currentLotteryId) {
        showAlert('没有待保存的抽签结果', 'error');
        return;
    }
    
    showAlert('抽签结果已保存为草稿，请在"查看抽签结果"页面进行修改和发布', 'success');
    hideLotteryConfirmModal();
    // 切换到分配管理选项卡
    showTab('allocations', null);
}

async function publishCurrentLottery() {
    if (!currentLotteryId) {
        showAlert('没有待发布的抽签结果', 'error');
        return;
    }
    
    try {
        const response = await api.publishLotteryResults(currentLotteryId);
        showAlert(response.message, 'success');
        hideLotteryConfirmModal();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteCurrentLottery() {
    if (!currentLotteryId) {
        showAlert('没有待删除的抽签结果', 'error');
        return;
    }
    
    if (!confirm('确定要删除此次抽签结果吗？删除后无法恢复。')) {
        return;
    }
    
    try {
        const response = await api.deleteLotteryResults(currentLotteryId);
        showAlert(response.message, 'success');
        hideLotteryConfirmModal();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showLotteryResultsModal() {
    document.getElementById('lotteryResultsModal').style.display = 'flex';
    loadLotteryResults();
}

function hideLotteryResultsModal() {
    document.getElementById('lotteryResultsModal').style.display = 'none';
}

async function loadLotteryResults() {
    try {
        const response = await api.getAllLotteryResults(1, 100); // 显示更多结果
        
        if (!response.results || response.results.length === 0) {
            document.getElementById('lotteryResultsContent').innerHTML = '<p>暂无抽签结果</p>';
            return;
        }
        
        // 按抽签ID分组显示结果
        const groupedResults = {};
        const lotterySettings = {};
        
        response.results.forEach(result => {
            if (!groupedResults[result.lottery_id]) {
                groupedResults[result.lottery_id] = [];
            }
            groupedResults[result.lottery_id].push(result);
            
            // 从结果中提取抽签设置信息
            if (!lotterySettings[result.lottery_id]) {
                lotterySettings[result.lottery_id] = {
                    lottery_name: result.lottery_name || '未知抽签',
                    is_published: result.is_published !== null && result.is_published !== undefined ? result.is_published : false
                };
            }
        });
        
        let html = '';
        Object.keys(groupedResults).forEach(lotteryId => {
            const results = groupedResults[lotteryId].sort((a, b) => a.lottery_number - b.lottery_number);
            const setting = lotterySettings[lotteryId];
            
            html += `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${setting ? setting.lottery_name : '未知抽签'}</h4>
                            <small>参与人数: ${results.length} | 
                                   状态: <span style="color: ${setting.is_published ? 'green' : 'orange'}">${setting.is_published ? '已发布' : '草稿（待发布）'}</span></small>
                        </div>
                        <div>
                            ${!setting.is_published ? `
                                <button class="btn btn-success" style="margin-right: 8px;" onclick="publishLottery(${lotteryId})">发布</button>
                            ` : ''}
                            <button class="btn btn-error" onclick="deleteLottery(${lotteryId})">删除</button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div style="max-height: 300px; overflow-y: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>抽签号</th>
                                        <th>姓名</th>
                                        <th>房间类型</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(result => `
                                        <tr>
                                            <td><strong>${result.lottery_number}</strong></td>
                                            <td>${result.user_name}</td>
                                            <td>${result.room_type ? `${result.room_type}人间` : '未分配'}</td>
                                            <td>
                                                <button class="btn btn-outline btn-sm" onclick="editLotteryResultInModal(${result.id}, ${result.lottery_number}, '${result.room_type ? result.room_type : ''}')">编辑房型</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('lotteryResultsContent').innerHTML = html;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('lotteryResultsContent').innerHTML = '<p>加载失败</p>';
    }
}

async function publishLottery(lotteryId) {
    try {
        const response = await api.publishLotteryResults(lotteryId);
        showAlert(response.message, 'success');
        loadLotteryResults(); // 重新加载结果
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteLottery(lotteryId) {
    if (!confirm('确定要删除此抽签结果吗？删除后无法恢复。')) {
        return;
    }
    
    try {
        const response = await api.deleteLotteryResults(lotteryId);
        showAlert(response.message, 'success');
        loadLotteryResults(); // 重新加载结果
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function editLotteryResultInModal(resultId, currentLotteryNumber, currentRoomType) {
    // 只编辑房间类型，不编辑抽签号码
    const roomTypeOptions = `
        <div style="text-align: center;">
            <p style="margin-bottom: 16px;">请选择新的房间类型：</p>
            <select id="tempRoomTypeSelect" style="padding: 8px; font-size: 16px; width: 150px;">
                <option value="">请选择</option>
                <option value="4" ${currentRoomType === '4' ? 'selected' : ''}>4人间</option>
                <option value="8" ${currentRoomType === '8' ? 'selected' : ''}>8人间</option>
            </select>
        </div>
    `;
    
    // 创建临时的模态框
    const tempModal = document.createElement('div');
    tempModal.className = 'modal-overlay';
    tempModal.style.display = 'flex';
    tempModal.style.zIndex = '1001';
    tempModal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">编辑抽签结果 - 房间类型</h3>
            </div>
            <div class="modal-content">
                <p><strong>抽签号码：</strong>${currentLotteryNumber}（固定不变）</p>
                ${roomTypeOptions}
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">取消</button>
                <button type="button" class="btn btn-primary" onclick="confirmEditLotteryRoomType(${resultId})">确认</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(tempModal);
}

async function confirmEditLotteryRoomType(resultId) {
    const selectElement = document.getElementById('tempRoomTypeSelect');
    const newRoomType = selectElement.value;
    
    if (!newRoomType) {
        showAlert('请选择房间类型', 'error');
        return;
    }
    
    try {
        // 只更新房间类型，不更新抽签号码
        const updateData = { 
            room_type: newRoomType
        };
        
        await api.updateLotteryResult(resultId, updateData);
        showAlert('房间类型更新成功', 'success');
        
        // 关闭临时模态框
        const tempModal = selectElement.closest('.modal-overlay');
        if (tempModal) {
            tempModal.remove();
        }
        
        // 重新加载结果
        loadLotteryResults();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 编辑抽签房间类型分配相关函数
function editLotteryRoomTypeAllocation(resultId, currentRoomType, userName) {
    currentEditLotteryResultId = resultId;
    
    document.getElementById('editLotteryUserName').textContent = userName;
    document.getElementById('editLotteryRoomType').value = currentRoomType || '';
    document.getElementById('editLotteryRoomTypeNotes').value = '';
    
    document.getElementById('editLotteryRoomTypeModal').style.display = 'flex';
}

function hideEditLotteryRoomTypeModal() {
    document.getElementById('editLotteryRoomTypeModal').style.display = 'none';
    document.getElementById('editLotteryRoomTypeForm').reset();
    currentEditLotteryResultId = null;
}

async function confirmEditLotteryRoomType() {
    if (!currentEditLotteryResultId) {
        showAlert('无效的编辑请求', 'error');
        return;
    }
    
    const roomType = document.getElementById('editLotteryRoomType').value;
    if (!roomType) {
        showAlert('请选择房间类型', 'error');
        return;
    }
    
    if (!['4', '8'].includes(roomType)) {
        showAlert('房间类型必须是4或8', 'error');
        return;
    }
    
    try {
        const response = await api.updateLotteryResult(currentEditLotteryResultId, {
            room_type: roomType
        });
        
        showAlert('房间类型分配更新成功', 'success');
        hideEditLotteryRoomTypeModal();
        loadRoomTypeAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 统计报告相关函数
async function loadStatistics() {
    try {
        const response = await api.getDetailedStatistics();
        const stats = response.statistics;
        
        // 更新统计数据显示
        document.getElementById('totalUsers').textContent = stats.total_users || 0;
        document.getElementById('roomTypeAllocatedUsers').textContent = stats.room_type_allocated_users || 0;
        document.getElementById('roomTypeUnallocatedUsers').textContent = stats.room_type_unallocated_users || 0;
        document.getElementById('roomAllocatedUsers').textContent = stats.room_allocated_users || 0;
        document.getElementById('roomUnallocatedUsers').textContent = stats.room_unallocated_users || 0;
        document.getElementById('confirmedUsers').textContent = stats.confirmed_users || 0;
        document.getElementById('unconfirmedUsers').textContent = stats.unconfirmed_users || 0;
        document.getElementById('room4Users').textContent = stats.room_4_users || 0;
        document.getElementById('room8Users').textContent = stats.room_8_users || 0;
        document.getElementById('totalBeds').textContent = stats.total_beds || 0;
        document.getElementById('occupiedBeds').textContent = stats.occupied_beds || 0;
        document.getElementById('availableBeds').textContent = stats.available_beds || 0;
        
        // 显示房间配置统计
        displayRoomCounts(stats.room_counts || {});
        
    } catch (error) {
        showAlert('加载统计数据失败: ' + error.message, 'error');
    }
}

function displayRoomCounts(roomCounts) {
    const chartContainer = document.getElementById('roomCountsChart');
    
    if (Object.keys(roomCounts).length === 0) {
        chartContainer.innerHTML = '<p style="text-align: center; color: #666;">暂无房间数据</p>';
        return;
    }
    
    let chartHtml = '<div style="display: flex; flex-wrap: wrap; gap: 16px; justify-content: center;">';
    
    Object.entries(roomCounts).forEach(([roomType, count]) => {
        const percentage = count > 0 ? ((count / Object.values(roomCounts).reduce((a, b) => a + b, 0)) * 100).toFixed(1) : 0;
        
        chartHtml += `
            <div class="stat-card" style="text-align: center; padding: 16px; border: 1px solid #ddd; border-radius: 8px; min-width: 120px;">
                <div style="font-size: 24px; font-weight: bold; color: #333;">${count}</div>
                <div style="font-size: 14px; color: #666; margin: 4px 0;">${roomType}人间</div>
                <div style="font-size: 12px; color: #999;">${percentage}%</div>
            </div>
        `;
    });
    
    chartHtml += '</div>';
    chartContainer.innerHTML = chartHtml;
}

async function refreshStatistics() {
    showAlert('正在刷新统计数据...', 'info');
    await loadStatistics();
    showAlert('统计数据已更新', 'success');
}

async function exportAllocations() {
    try {
        showAlert('正在生成Excel报告，请稍候...', 'info');
        const result = await api.exportAllocations();
        showAlert(result.message, 'success');
    } catch (error) {
        showAlert('导出失败: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
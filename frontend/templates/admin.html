{% extends "base.html" %}

{% block title %}管理后台 - 宿舍抽签系统{% endblock %}

{% block content %}
<div class="container">
    <h1>管理后台</h1>
    
    <!-- 功能选项卡 -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-content">
            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" onclick="showTab('users')">用户管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('buildings')">建筑管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('rooms')">房间管理</button>
                <button type="button" class="btn btn-outline" onclick="showTab('allocations')">分配管理</button>
            </div>
        </div>
    </div>

    <!-- 用户管理选项卡 -->
    <div id="usersTab" class="tab-content">
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <h3 class="card-title">用户管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="userSearch" class="form-input" placeholder="搜索用户..." style="width: 200px;">
                        <button type="button" class="btn btn-outline" onclick="loadUsers()">搜索</button>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="showCreateUserModal()">新建用户</button>
                        <label for="userImportFile" class="btn btn-outline">
                            导入用户CSV
                            <input type="file" id="userImportFile" accept=".csv" style="display: none;" onchange="importUsers()">
                        </label>
                    </div>
                </div>
                <div id="usersTable">
                    <!-- 用户表格将通过JavaScript加载 -->
                </div>
                <div id="usersPagination" style="margin-top: 16px;">
                    <!-- 分页将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 建筑管理选项卡 -->
    <div id="buildingsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">建筑管理</h3>
            </div>
            <div class="card-content">
                <div style="margin-bottom: 16px;">
                    <button type="button" class="btn btn-primary" onclick="showCreateBuildingModal()">新增建筑</button>
                </div>
                <div id="buildingsTable">
                    <!-- 建筑表格将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 房间管理选项卡 -->
    <div id="roomsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">房间管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; gap: 16px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                    <select id="buildingFilter" class="form-input" style="width: 200px;" onchange="loadRooms()">
                        <option value="">所有建筑</option>
                    </select>
                    <select id="roomTypeFilter" class="form-input" style="width: 150px;" onchange="loadRooms()">
                        <option value="">所有类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                    <button type="button" class="btn btn-primary" onclick="showCreateRoomModal()">新增房间</button>
                    <label for="roomImportFile" class="btn btn-outline">
                        批量导入房间CSV
                        <input type="file" id="roomImportFile" accept=".csv" style="display: none;" onchange="importRooms()">
                    </label>
                </div>
                <div id="roomsTable">
                    <!-- 房间表格将通过JavaScript加载 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 分配管理选项卡 -->
    <div id="allocationsTab" class="tab-content" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">宿舍分配管理</h3>
            </div>
            <div class="card-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h4>寝室类型分配管理</h4>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="button" class="btn btn-primary" onclick="showRoomTypeAllocationModal()">分配寝室类型</button>
                        <button type="button" class="btn btn-outline" onclick="showManualAllocationModal()">分配具体宿舍</button>
                        <button type="button" class="btn btn-outline" onclick="showQuickLotteryModal()">一键抽签</button>
                        <button type="button" class="btn btn-outline" onclick="showLotteryResultsModal()">查看抽签结果</button>
                    </div>
                </div>
                
                <!-- 选项卡切换 -->
                <div style="margin-bottom: 16px;">
                    <button type="button" class="btn btn-primary" id="roomTypeTabBtn" onclick="showAllocationTab('roomType')">寝室类型分配</button>
                    <button type="button" class="btn btn-outline" id="specificRoomTabBtn" onclick="showAllocationTab('specificRoom')">具体宿舍分配</button>
                </div>
                
                <!-- 寝室类型分配选项卡 -->
                <div id="roomTypeAllocationsTab">
                    <div id="roomTypeAllocationsTable">
                        <!-- 寝室类型分配表格将通过JavaScript加载 -->
                    </div>
                    <div id="roomTypeAllocationsPagination" style="margin-top: 16px;">
                        <!-- 分页将通过JavaScript加载 -->
                    </div>
                </div>
                
                <!-- 具体宿舍分配选项卡 -->
                <div id="specificRoomAllocationsTab" style="display: none;">
                    <div id="allocationsTable">
                        <!-- 分配表格将通过JavaScript加载 -->
                    </div>
                    <div id="allocationsPagination" style="margin-top: 16px;">
                        <!-- 分页将通过JavaScript加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增建筑模态框 -->
<div id="createBuildingModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新增建筑</h3>
        </div>
        <div class="modal-content">
            <form id="createBuildingForm">
                <div class="form-group">
                    <label class="form-label">建筑名称</label>
                    <input type="text" id="buildingName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">描述</label>
                    <textarea id="buildingDescription" class="form-input" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateBuildingModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createBuilding()">创建</button>
        </div>
    </div>
</div>

<!-- 新建用户模态框 -->
<div id="createUserModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新建用户</h3>
        </div>
        <div class="modal-content">
            <form id="createUserForm">
                <div class="form-group">
                    <label class="form-label">姓名</label>
                    <input type="text" id="userName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" id="userUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="password" id="userPassword" class="form-input" required minlength="6">
                    <small class="form-text">密码长度不能少于6位</small>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateUserModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createUser()">创建</button>
        </div>
    </div>
</div>

<!-- 新增房间模态框 -->
<div id="createRoomModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">新增房间</h3>
        </div>
        <div class="modal-content">
            <form id="createRoomForm">
                <div class="form-group">
                    <label class="form-label">选择建筑</label>
                    <select id="roomBuildingId" class="form-input" required>
                        <option value="">请选择建筑</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">房间号</label>
                    <input type="text" id="roomNumber" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="roomType" class="form-input" required>
                        <option value="">请选择类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">最大容量</label>
                    <input type="number" id="maxCapacity" class="form-input" required min="1" max="8">
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideCreateRoomModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createRoom()">创建</button>
        </div>
    </div>
</div>

<!-- 寝室类型分配模态框 -->
<div id="roomTypeAllocationModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">分配寝室类型</h3>
        </div>
        <div class="modal-content">
            <div style="display: flex; gap: 24px;">
                <!-- 左侧：未分配寝室类型用户列表 -->
                <div style="flex: 1;">
                    <h4>未分配寝室类型用户</h4>
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="unallocatedRoomTypeUserSearch" class="form-input" placeholder="搜索用户..." style="width: 100%;" oninput="loadUnallocatedRoomTypeUsers()">
                    </div>
                    <div id="unallocatedRoomTypeUsersTable" style="max-height: 300px; overflow-y: auto;">
                        <!-- 未分配寝室类型用户表格 -->
                    </div>
                </div>
                
                <!-- 右侧：寝室类型选择 -->
                <div style="flex: 1;">
                    <h4>选择寝室类型</h4>
                    <div id="selectedRoomTypeUserInfo" style="margin-bottom: 16px; padding: 12px; background-color: #f5f5f5; border-radius: 4px; display: none;">
                        <strong>已选择用户：</strong><span id="selectedRoomTypeUserName"></span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <select id="roomTypeSelect" class="form-input" style="width: 100%;">
                            <option value="">请选择寝室类型</option>
                            <option value="4">4人间</option>
                            <option value="8">8人间</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">备注</label>
                        <textarea id="roomTypeNotes" class="form-input" rows="3" placeholder="可选的备注信息"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideRoomTypeAllocationModal()">取消</button>
            <button type="button" class="btn btn-primary" id="confirmRoomTypeAllocationBtn" onclick="confirmRoomTypeAllocation()" disabled>确认分配</button>
        </div>
    </div>
</div>

<!-- 手动分配模态框 -->
<div id="manualAllocationModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 class="modal-title">手动分配宿舍</h3>
        </div>
        <div class="modal-content">
            <div style="display: flex; gap: 24px;">
                <!-- 左侧：未分配用户列表 -->
                <div style="flex: 1;">
                    <h4>未分配用户</h4>
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="unallocatedUserSearch" class="form-input" placeholder="搜索用户..." style="width: 100%;" oninput="loadUnallocatedUsers()">
                    </div>
                    <div id="unallocatedUsersTable" style="max-height: 300px; overflow-y: auto;">
                        <!-- 未分配用户表格 -->
                    </div>
                </div>
                
                <!-- 右侧：房间床位选择 -->
                <div style="flex: 1;">
                    <h4>选择房间和床位</h4>
                    <div id="selectedUserInfo" style="margin-bottom: 16px; padding: 12px; background-color: #f5f5f5; border-radius: 4px; display: none;">
                        <strong>已选择用户：</strong><span id="selectedUserName"></span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <select id="allocationBuildingSelect" class="form-input" style="width: 100%; margin-bottom: 8px;" onchange="loadRoomsForAllocation()">
                            <option value="">请选择建筑</option>
                        </select>
                        <select id="allocationRoomSelect" class="form-input" style="width: 100%;" onchange="loadBedsForAllocation()">
                            <option value="">请选择房间</option>
                        </select>
                    </div>
                    <div id="bedsTable" style="max-height: 200px; overflow-y: auto;">
                        <!-- 床位表格 -->
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideManualAllocationModal()">取消</button>
            <button type="button" class="btn btn-primary" id="confirmAllocationBtn" onclick="confirmManualAllocation()" disabled>确认分配</button>
        </div>
    </div>
</div>

<!-- 一键抽签模态框 -->
<div id="quickLotteryModal" class="modal-overlay" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">一键抽签</h3>
        </div>
        <div class="modal-content">
            <form id="quickLotteryForm">
                <div class="form-group">
                    <label class="form-label">抽签名称</label>
                    <input type="text" id="lotteryName" class="form-input" required placeholder="例如：2024年春季宿舍抽签">
                </div>
                <div class="form-group">
                    <label class="form-label">房间类型</label>
                    <select id="lotteryRoomType" class="form-input" required>
                        <option value="">请选择房间类型</option>
                        <option value="4">4人间</option>
                        <option value="8">8人间</option>
                    </select>
                </div>
                <div class="form-group">
                    <p class="form-text">系统将自动为所有非管理员用户生成抽签号码，抽签结果默认保存为草稿状态，您可以选择发布或删除。</p>
                </div>
            </form>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideQuickLotteryModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="performQuickLottery()">开始抽签</button>
        </div>
    </div>
</div>

<!-- 抽签结果查看模态框 -->
<div id="lotteryResultsModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">抽签结果管理</h3>
        </div>
        <div class="modal-content">
            <div id="lotteryResultsContent">
                <!-- 抽签结果内容将通过JavaScript加载 -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideLotteryResultsModal()">关闭</button>
        </div>
    </div>
</div>

<!-- 抽签结果确认模态框 -->
<div id="lotteryConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h3 class="modal-title">抽签完成</h3>
        </div>
        <div class="modal-content">
            <div id="lotteryConfirmContent">
                <!-- 抽签确认内容将通过JavaScript加载 -->
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-outline" onclick="hideLotteryConfirmModal()">关闭</button>
            <button type="button" class="btn btn-success" id="publishLotteryBtn" onclick="publishCurrentLottery()">发布结果</button>
            <button type="button" class="btn btn-error" id="deleteLotteryBtn" onclick="deleteCurrentLottery()">删除重抽</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTab = 'users';
let currentUsersPage = 1;
let currentAllocationsPage = 1;
let currentRoomTypeAllocationsPage = 1;
let buildings = [];
let currentLotteryId = null;
let selectedUserId = null;
let selectedUserName = '';
let selectedBedId = null;
let selectedRoomTypeUserId = null;
let selectedRoomTypeUserName = '';
let currentAllocationTab = 'roomType';

document.addEventListener('DOMContentLoaded', function() {
    if (!requireAdmin()) return;
    
    showTab('users');
});

function showTab(tabName) {
    // 隐藏所有选项卡
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // 更新按钮状态
    document.querySelectorAll('.card-content button').forEach(btn => {
        btn.className = 'btn btn-outline';
    });
    
    // 显示选中的选项卡
    document.getElementById(tabName + 'Tab').style.display = 'block';
    event.target.className = 'btn btn-primary';
    
    currentTab = tabName;
    
    // 加载对应数据
    switch(tabName) {
        case 'users':
            loadUsers();
            break;
        case 'buildings':
            loadBuildings();
            break;
        case 'rooms':
            loadBuildingsForFilter();
            loadRooms();
            break;
        case 'allocations':
            loadRoomTypeAllocations();
            break;
    }
}

// 用户管理相关函数
async function loadUsers() {
    const search = document.getElementById('userSearch').value;
    
    try {
        const response = await api.getUsers(currentUsersPage, 20, search);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>角色</th>
                        <th>注册时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>${user.is_admin ? '管理员' : '普通用户'}</td>
                            <td>${formatDate(user.created_at)}</td>
                            <td>
                                ${!user.is_admin ? `
                                    <button class="btn btn-outline" style="margin-right: 8px;" onclick="resetPassword(${user.id})">重置密码</button>
                                    <button class="btn btn-error" onclick="deleteUser(${user.id})">删除</button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('usersTable').innerHTML = table;
        
        // 更新分页
        updateUsersPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function importUsers() {
    const fileInput = document.getElementById('userImportFile');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    try {
        const response = await api.importUsers(file);
        showAlert(`导入完成：新增 ${response.created_count} 个用户，跳过 ${response.skipped_count} 个用户`, 'success');
        
        if (response.errors.length > 0) {
            showAlert(`错误信息：${response.errors.join('; ')}`, 'warning');
        }
        
        loadUsers();
        fileInput.value = '';
    } catch (error) {
        showAlert(error.message, 'error');
        fileInput.value = '';
    }
}

async function deleteUser(userId) {
    if (!confirm('确定要删除此用户吗？')) return;
    
    try {
        await api.deleteUser(userId);
        showAlert('用户删除成功', 'success');
        loadUsers();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function resetPassword(userId) {
    const newPassword = prompt('请输入新密码（至少6位）：');
    if (!newPassword || newPassword.length < 6) {
        showAlert('密码长度不能少于6位', 'error');
        return;
    }
    
    try {
        await api.resetUserPassword(userId, newPassword);
        showAlert('密码重置成功', 'success');
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateUsersPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changePage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changePage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('usersPagination').innerHTML = paginationHtml;
}

function changePage(page) {
    currentUsersPage = page;
    loadUsers();
}

// 用户创建相关函数
function showCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'flex';
}

function hideCreateUserModal() {
    document.getElementById('createUserModal').style.display = 'none';
    document.getElementById('createUserForm').reset();
}

async function createUser() {
    const name = document.getElementById('userName').value.trim();
    const username = document.getElementById('userUsername').value.trim();
    const password = document.getElementById('userPassword').value;
    
    if (!name || !username || !password) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    if (password.length < 6) {
        showAlert('密码长度不能少于6位', 'error');
        return;
    }
    
    try {
        await api.createUser({ name, username, password });
        showAlert('用户创建成功', 'success');
        hideCreateUserModal();
        loadUsers();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 建筑管理相关函数
async function loadBuildings() {
    try {
        const response = await api.getBuildings();
        buildings = response.buildings;
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>建筑名称</th>
                        <th>描述</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${buildings.map(building => `
                        <tr>
                            <td>${building.name}</td>
                            <td>${building.description || ''}</td>
                            <td>${formatDate(building.created_at)}</td>
                            <td>
                                <button class="btn btn-error btn-sm" onclick="deleteBuilding(${building.id})">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('buildingsTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showCreateBuildingModal() {
    document.getElementById('createBuildingModal').style.display = 'flex';
}

function hideCreateBuildingModal() {
    document.getElementById('createBuildingModal').style.display = 'none';
    document.getElementById('createBuildingForm').reset();
}

async function createBuilding() {
    const name = document.getElementById('buildingName').value;
    const description = document.getElementById('buildingDescription').value;
    
    if (!name) {
        showAlert('建筑名称不能为空', 'error');
        return;
    }
    
    try {
        await api.createBuilding({ name, description });
        showAlert('建筑创建成功', 'success');
        hideCreateBuildingModal();
        loadBuildings();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteBuilding(buildingId) {
    if (!confirm('确定要删除此建筑吗？删除前请确保该建筑下没有房间。')) return;
    
    try {
        await api.deleteBuilding(buildingId);
        showAlert('建筑删除成功', 'success');
        loadBuildings();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 房间管理相关函数
async function loadBuildingsForFilter() {
    try {
        const response = await api.getBuildings();
        buildings = response.buildings;
        
        const buildingSelect = document.getElementById('buildingFilter');
        const roomBuildingSelect = document.getElementById('roomBuildingId');
        
        const options = buildings.map(building => 
            `<option value="${building.id}">${building.name}</option>`
        ).join('');
        
        buildingSelect.innerHTML = '<option value="">所有建筑</option>' + options;
        roomBuildingSelect.innerHTML = '<option value="">请选择建筑</option>' + options;
    } catch (error) {
        console.error('加载建筑列表失败:', error);
    }
}

async function loadRooms() {
    const buildingId = document.getElementById('buildingFilter').value;
    const roomType = document.getElementById('roomTypeFilter').value;
    
    try {
        const response = await api.getRooms(buildingId || null, roomType || null);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>建筑</th>
                        <th>房间号</th>
                        <th>类型</th>
                        <th>容量</th>
                        <th>当前入住</th>
                        <th>状态</th>
                        <th>可用床位</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.rooms.map(room => `
                        <tr>
                            <td>${room.building_name}</td>
                            <td>${room.room_number}</td>
                            <td>${room.room_type}人间</td>
                            <td>${room.max_capacity}</td>
                            <td>${room.current_occupancy}</td>
                            <td>${room.is_available ? '可用' : '不可用'}</td>
                            <td>${room.available_beds}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('roomsTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'flex';
}

function hideCreateRoomModal() {
    document.getElementById('createRoomModal').style.display = 'none';
    document.getElementById('createRoomForm').reset();
}

async function createRoom() {
    const buildingId = document.getElementById('roomBuildingId').value;
    const roomNumber = document.getElementById('roomNumber').value;
    const roomType = document.getElementById('roomType').value;
    const maxCapacity = document.getElementById('maxCapacity').value;
    
    if (!buildingId || !roomNumber || !roomType || !maxCapacity) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    try {
        await api.createRoom({
            building_id: parseInt(buildingId),
            room_number: roomNumber,
            room_type: roomType,
            max_capacity: parseInt(maxCapacity)
        });
        showAlert('房间创建成功', 'success');
        hideCreateRoomModal();
        loadRooms();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function importRooms() {
    const fileInput = document.getElementById('roomImportFile');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    try {
        const response = await api.importRooms(file);
        showAlert(`房间导入完成：新增 ${response.created_count} 个房间，跳过 ${response.skipped_count} 个房间`, 'success');
        
        if (response.errors.length > 0) {
            showAlert(`错误信息：${response.errors.join('; ')}`, 'warning');
        }
        
        loadRooms();
        fileInput.value = '';
    } catch (error) {
        showAlert(error.message, 'error');
        fileInput.value = '';
    }
}

// 分配管理相关函数
function showAllocationTab(tabName) {
    // 更新按钮状态
    document.getElementById('roomTypeTabBtn').className = 'btn btn-outline';
    document.getElementById('specificRoomTabBtn').className = 'btn btn-outline';
    
    // 隐藏所有选项卡
    document.getElementById('roomTypeAllocationsTab').style.display = 'none';
    document.getElementById('specificRoomAllocationsTab').style.display = 'none';
    
    // 显示选中的选项卡
    if (tabName === 'roomType') {
        document.getElementById('roomTypeTabBtn').className = 'btn btn-primary';
        document.getElementById('roomTypeAllocationsTab').style.display = 'block';
        loadRoomTypeAllocations();
    } else {
        document.getElementById('specificRoomTabBtn').className = 'btn btn-primary';
        document.getElementById('specificRoomAllocationsTab').style.display = 'block';
        loadAllocations();
    }
    
    currentAllocationTab = tabName;
}

async function loadRoomTypeAllocations() {
    try {
        const response = await api.getRoomTypeAllocations(currentRoomTypeAllocationsPage, 20);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>用户名</th>
                        <th>寝室类型</th>
                        <th>分配时间</th>
                        <th>分配人员</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.allocations.map(allocation => `
                        <tr>
                            <td>${allocation.user_name}</td>
                            <td>${allocation.user_username}</td>
                            <td>${allocation.room_type}人间</td>
                            <td>${formatDate(allocation.allocated_at)}</td>
                            <td>${allocation.allocator_name || '系统'}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" style="margin-right: 8px;" onclick="editRoomTypeAllocation(${allocation.id}, '${allocation.room_type}', '${allocation.notes || ''}')">编辑</button>
                                <button class="btn btn-error btn-sm" onclick="deleteRoomTypeAllocation(${allocation.id})">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('roomTypeAllocationsTable').innerHTML = table;
        
        // 更新分页
        updateRoomTypeAllocationsPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateRoomTypeAllocationsPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeRoomTypeAllocationsPage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeRoomTypeAllocationsPage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('roomTypeAllocationsPagination').innerHTML = paginationHtml;
}

function changeRoomTypeAllocationsPage(page) {
    currentRoomTypeAllocationsPage = page;
    loadRoomTypeAllocations();
}

async function loadAllocations() {
    try {
        const response = await api.getAllocations(currentAllocationsPage, 20);
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>学生姓名</th>
                        <th>建筑</th>
                        <th>房间号</th>
                        <th>床位号</th>
                        <th>选择时间</th>
                        <th>确认状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.allocations.map(allocation => `
                        <tr>
                            <td>${allocation.user_name}</td>
                            <td>${allocation.building_name}</td>
                            <td>${allocation.room_number}</td>
                            <td>${allocation.bed_number}</td>
                            <td>${formatDate(allocation.selected_at)}</td>
                            <td>${allocation.is_confirmed ? '已确认' : '未确认'}</td>
                            <td>
                                <button class="btn btn-outline" style="margin-right: 8px;" onclick="editAllocation(${allocation.id})">编辑</button>
                                <button class="btn btn-error" onclick="deleteAllocation(${allocation.id})">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('allocationsTable').innerHTML = table;
        
        // 更新分页
        updateAllocationsPagination(response.current_page, response.pages);
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteAllocation(allocationId) {
    if (!confirm('确定要删除此分配吗？')) return;
    
    try {
        await api.deleteAllocation(allocationId);
        showAlert('分配删除成功', 'success');
        loadAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function updateAllocationsPagination(currentPage, totalPages) {
    let paginationHtml = '';
    
    if (totalPages > 1) {
        paginationHtml = '<div style="display: flex; gap: 8px; justify-content: center;">';
        
        if (currentPage > 1) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeAllocationsPage(${currentPage - 1})">上一页</button>`;
        }
        
        paginationHtml += `<span style="padding: 12px;">第 ${currentPage} 页，共 ${totalPages} 页</span>`;
        
        if (currentPage < totalPages) {
            paginationHtml += `<button class="btn btn-outline" onclick="changeAllocationsPage(${currentPage + 1})">下一页</button>`;
        }
        
        paginationHtml += '</div>';
    }
    
    document.getElementById('allocationsPagination').innerHTML = paginationHtml;
}

function changeAllocationsPage(page) {
    currentAllocationsPage = page;
    loadAllocations();
}

// 手动分配相关函数
function showManualAllocationModal() {
    document.getElementById('manualAllocationModal').style.display = 'flex';
    loadUnallocatedUsers();
    loadBuildingsForAllocation();
    resetAllocationSelection();
}

function hideManualAllocationModal() {
    document.getElementById('manualAllocationModal').style.display = 'none';
    resetAllocationSelection();
}

function resetAllocationSelection() {
    selectedUserId = null;
    selectedUserName = '';
    selectedBedId = null;
    document.getElementById('selectedUserInfo').style.display = 'none';
    document.getElementById('allocationBuildingSelect').value = '';
    document.getElementById('allocationRoomSelect').innerHTML = '<option value="">请选择房间</option>';
    document.getElementById('bedsTable').innerHTML = '';
    document.getElementById('confirmAllocationBtn').disabled = true;
    document.getElementById('unallocatedUserSearch').value = '';
}

async function loadUnallocatedUsers() {
    const search = document.getElementById('unallocatedUserSearch').value;
    
    try {
        const response = await api.getUnallocatedUsers(1, 50, search);
        
        if (!response.users || response.users.length === 0) {
            document.getElementById('unallocatedUsersTable').innerHTML = '<p>暂无未分配用户</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr ${selectedUserId === user.id ? 'style="background-color: #e3f2fd;"' : ''}>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectUserForAllocation(${user.id}, '${user.name}')">
                                    ${selectedUserId === user.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('unallocatedUsersTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('unallocatedUsersTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectUserForAllocation(userId, userName) {
    selectedUserId = userId;
    selectedUserName = userName;
    document.getElementById('selectedUserName').textContent = userName;
    document.getElementById('selectedUserInfo').style.display = 'block';
    loadUnallocatedUsers(); // 重新加载以更新选择状态
    updateConfirmButton();
}

async function loadBuildingsForAllocation() {
    try {
        const response = await api.getBuildings();
        const select = document.getElementById('allocationBuildingSelect');
        
        const options = response.buildings.map(building => 
            `<option value="${building.id}">${building.name}</option>`
        ).join('');
        
        select.innerHTML = '<option value="">请选择建筑</option>' + options;
    } catch (error) {
        console.error('加载建筑列表失败:', error);
    }
}

async function loadRoomsForAllocation() {
    const buildingId = document.getElementById('allocationBuildingSelect').value;
    const roomSelect = document.getElementById('allocationRoomSelect');
    
    if (!buildingId) {
        roomSelect.innerHTML = '<option value="">请选择房间</option>';
        document.getElementById('bedsTable').innerHTML = '';
        return;
    }
    
    try {
        const response = await api.getRooms(buildingId);
        
        const availableRooms = response.rooms.filter(room => room.available_beds > 0);
        
        const options = availableRooms.map(room => 
            `<option value="${room.id}">${room.room_number} (${room.room_type}人间, 剩余${room.available_beds}个床位)</option>`
        ).join('');
        
        roomSelect.innerHTML = '<option value="">请选择房间</option>' + options;
        document.getElementById('bedsTable').innerHTML = '';
    } catch (error) {
        console.error('加载房间列表失败:', error);
    }
}

async function loadBedsForAllocation() {
    const roomId = document.getElementById('allocationRoomSelect').value;
    
    if (!roomId) {
        document.getElementById('bedsTable').innerHTML = '';
        return;
    }
    
    try {
        const response = await api.getRooms();
        const room = response.rooms.find(r => r.id === parseInt(roomId));
        
        if (!room || !room.beds) {
            document.getElementById('bedsTable').innerHTML = '<p>暂无床位信息</p>';
            return;
        }
        
        const availableBeds = room.beds.filter(bed => !bed.is_occupied);
        
        if (availableBeds.length === 0) {
            document.getElementById('bedsTable').innerHTML = '<p>该房间暂无可用床位</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>床位号</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${availableBeds.map(bed => `
                        <tr ${selectedBedId === bed.id ? 'style="background-color: #e8f5e8;"' : ''}>
                            <td>${bed.bed_number}</td>
                            <td>可用</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectBedForAllocation(${bed.id})">
                                    ${selectedBedId === bed.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('bedsTable').innerHTML = table;
    } catch (error) {
        console.error('加载床位列表失败:', error);
        document.getElementById('bedsTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectBedForAllocation(bedId) {
    selectedBedId = bedId;
    loadBedsForAllocation(); // 重新加载以更新选择状态
    updateConfirmButton();
}

function updateConfirmButton() {
    const confirmBtn = document.getElementById('confirmAllocationBtn');
    confirmBtn.disabled = !(selectedUserId && selectedBedId);
}

async function confirmManualAllocation() {
    if (!selectedUserId || !selectedBedId) {
        showAlert('请选择用户和床位', 'error');
        return;
    }
    
    const roomId = document.getElementById('allocationRoomSelect').value;
    
    if (!roomId) {
        showAlert('请选择房间', 'error');
        return;
    }
    
    try {
        const response = await api.createAllocation({
            user_id: selectedUserId,
            room_id: parseInt(roomId),
            bed_id: selectedBedId
        });
        
        showAlert(response.message, 'success');
        hideManualAllocationModal();
        loadAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 模态框事件处理
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
});

// 房间类型和容量联动
document.getElementById('roomType').addEventListener('change', function() {
    const maxCapacityInput = document.getElementById('maxCapacity');
    const value = this.value;
    
    if (value === '4') {
        maxCapacityInput.value = '4';
    } else if (value === '8') {
        maxCapacityInput.value = '8';
    }
});

// 寝室类型分配相关函数
function showRoomTypeAllocationModal() {
    document.getElementById('roomTypeAllocationModal').style.display = 'flex';
    loadUnallocatedRoomTypeUsers();
    resetRoomTypeAllocationSelection();
}

function hideRoomTypeAllocationModal() {
    document.getElementById('roomTypeAllocationModal').style.display = 'none';
    resetRoomTypeAllocationSelection();
}

function resetRoomTypeAllocationSelection() {
    selectedRoomTypeUserId = null;
    selectedRoomTypeUserName = '';
    document.getElementById('selectedRoomTypeUserInfo').style.display = 'none';
    document.getElementById('roomTypeSelect').value = '';
    document.getElementById('roomTypeNotes').value = '';
    document.getElementById('confirmRoomTypeAllocationBtn').disabled = true;
    document.getElementById('unallocatedRoomTypeUserSearch').value = '';
}

async function loadUnallocatedRoomTypeUsers() {
    const search = document.getElementById('unallocatedRoomTypeUserSearch').value;
    
    try {
        const response = await api.getUnallocatedRoomTypeUsers(1, 50, search);
        
        if (!response.users || response.users.length === 0) {
            document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = '<p>暂无未分配寝室类型用户</p>';
            return;
        }
        
        const table = `
            <table class="table">
                <thead>
                    <tr>
                        <th>姓名</th>
                        <th>用户名</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${response.users.map(user => `
                        <tr ${selectedRoomTypeUserId === user.id ? 'style="background-color: #e3f2fd;"' : ''}>
                            <td>${user.name}</td>
                            <td>${user.username}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" onclick="selectUserForRoomType(${user.id}, '${user.name}')">
                                    ${selectedRoomTypeUserId === user.id ? '已选择' : '选择'}
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        
        document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = table;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('unallocatedRoomTypeUsersTable').innerHTML = '<p>加载失败</p>';
    }
}

function selectUserForRoomType(userId, userName) {
    selectedRoomTypeUserId = userId;
    selectedRoomTypeUserName = userName;
    document.getElementById('selectedRoomTypeUserName').textContent = userName;
    document.getElementById('selectedRoomTypeUserInfo').style.display = 'block';
    loadUnallocatedRoomTypeUsers(); // 重新加载以更新选择状态
    updateRoomTypeConfirmButton();
}

function updateRoomTypeConfirmButton() {
    const roomType = document.getElementById('roomTypeSelect').value;
    const confirmBtn = document.getElementById('confirmRoomTypeAllocationBtn');
    confirmBtn.disabled = !(selectedRoomTypeUserId && roomType);
}

// 添加事件监听器
document.getElementById('roomTypeSelect').addEventListener('change', updateRoomTypeConfirmButton);

async function confirmRoomTypeAllocation() {
    if (!selectedRoomTypeUserId) {
        showAlert('请选择用户', 'error');
        return;
    }
    
    const roomType = document.getElementById('roomTypeSelect').value;
    const notes = document.getElementById('roomTypeNotes').value;
    
    if (!roomType) {
        showAlert('请选择寝室类型', 'error');
        return;
    }
    
    try {
        const response = await api.createRoomTypeAllocation({
            user_id: selectedRoomTypeUserId,
            room_type: roomType,
            notes: notes
        });
        
        showAlert(response.message, 'success');
        hideRoomTypeAllocationModal();
        loadRoomTypeAllocations(); // 重新加载分配列表
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function editRoomTypeAllocation(allocationId, currentRoomType, currentNotes) {
    const newRoomType = prompt('请选择新的寝室类型 (4 或 8):', currentRoomType);
    if (!newRoomType || !['4', '8'].includes(newRoomType)) {
        showAlert('寝室类型只能是4或8', 'error');
        return;
    }
    
    const newNotes = prompt('备注:', currentNotes || '');
    
    try {
        const response = await api.updateRoomTypeAllocation(allocationId, {
            room_type: newRoomType,
            notes: newNotes || ''
        });
        
        showAlert(response.message, 'success');
        loadRoomTypeAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteRoomTypeAllocation(allocationId) {
    if (!confirm('确定要删除此寝室类型分配吗？')) return;
    
    try {
        const response = await api.deleteRoomTypeAllocation(allocationId);
        showAlert(response.message, 'success');
        loadRoomTypeAllocations();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

// 抽签管理相关函数
function showQuickLotteryModal() {
    document.getElementById('quickLotteryModal').style.display = 'flex';
}

function hideQuickLotteryModal() {
    document.getElementById('quickLotteryModal').style.display = 'none';
    document.getElementById('quickLotteryForm').reset();
}

async function performQuickLottery() {
    const lotteryName = document.getElementById('lotteryName').value.trim();
    const roomType = document.getElementById('lotteryRoomType').value;
    
    if (!lotteryName || !roomType) {
        showAlert('请填写所有必填字段', 'error');
        return;
    }
    
    const button = event.target;
    const hideLoading = showLoading(button);
    
    try {
        const response = await api.quickLotteryDraw({
            lottery_name: lotteryName,
            room_type: roomType
        });
        
        hideQuickLotteryModal();
        showAlert(response.message, 'success');
        
        // 显示抽签结果确认对话框
        currentLotteryId = response.lottery_id;
        showLotteryConfirmDialog(response);
        
    } catch (error) {
        showAlert(error.message, 'error');
    } finally {
        hideLoading();
    }
}

function showLotteryConfirmDialog(lotteryData) {
    const content = `
        <div style="margin-bottom: 16px;">
            <p><strong>抽签名称：</strong>${lotteryData.lottery_name}</p>
            <p><strong>房间类型：</strong>${lotteryData.room_type || lotteryData.total_groups ? '根据分组判断' : ''}人间</p>
            <p><strong>参与人数：</strong>${lotteryData.total_participants}人</p>
            <p><strong>分组数量：</strong>${lotteryData.total_groups}组</p>
        </div>
        <div class="alert alert-warning">
            <p>抽签已完成并保存为草稿状态。请选择：</p>
            <ul>
                <li><strong>发布结果：</strong>学生将可以看到抽签结果</li>
                <li><strong>删除重抽：</strong>删除此次抽签结果，重新进行抽签</li>
            </ul>
        </div>
    `;
    
    document.getElementById('lotteryConfirmContent').innerHTML = content;
    document.getElementById('lotteryConfirmModal').style.display = 'flex';
}

function hideLotteryConfirmModal() {
    document.getElementById('lotteryConfirmModal').style.display = 'none';
    currentLotteryId = null;
}

async function publishCurrentLottery() {
    if (!currentLotteryId) {
        showAlert('没有待发布的抽签结果', 'error');
        return;
    }
    
    try {
        const response = await api.publishLotteryResults(currentLotteryId);
        showAlert(response.message, 'success');
        hideLotteryConfirmModal();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteCurrentLottery() {
    if (!currentLotteryId) {
        showAlert('没有待删除的抽签结果', 'error');
        return;
    }
    
    if (!confirm('确定要删除此次抽签结果吗？删除后无法恢复。')) {
        return;
    }
    
    try {
        const response = await api.deleteLotteryResults(currentLotteryId);
        showAlert(response.message, 'success');
        hideLotteryConfirmModal();
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

function showLotteryResultsModal() {
    document.getElementById('lotteryResultsModal').style.display = 'flex';
    loadLotteryResults();
}

function hideLotteryResultsModal() {
    document.getElementById('lotteryResultsModal').style.display = 'none';
}

async function loadLotteryResults() {
    try {
        const response = await api.getAllLotteryResults(1, 50); // 显示更多结果
        
        if (!response.results || response.results.length === 0) {
            document.getElementById('lotteryResultsContent').innerHTML = '<p>暂无抽签结果</p>';
            return;
        }
        
        // 按抽签ID分组显示结果
        const groupedResults = {};
        response.results.forEach(result => {
            if (!groupedResults[result.lottery_id]) {
                groupedResults[result.lottery_id] = [];
            }
            groupedResults[result.lottery_id].push(result);
        });
        
        let html = '';
        Object.keys(groupedResults).forEach(lotteryId => {
            const results = groupedResults[lotteryId];
            const setting = response.settings[lotteryId];
            
            html += `
                <div class="card" style="margin-bottom: 16px;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4>${setting ? setting.lottery_name : '未知抽签'}</h4>
                            <small>创建时间: ${setting ? formatDate(setting.created_at) : ''} | 
                                   状态: ${setting && setting.is_published ? '已发布' : '草稿'}</small>
                        </div>
                        <div>
                            ${setting && !setting.is_published ? `
                                <button class="btn btn-success" style="margin-right: 8px;" onclick="publishLottery(${lotteryId})">发布</button>
                                <button class="btn btn-error" onclick="deleteLottery(${lotteryId})">删除</button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="card-content">
                        <div style="max-height: 200px; overflow-y: auto;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>抽签号</th>
                                        <th>姓名</th>
                                        <th>分组</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(result => `
                                        <tr>
                                            <td>${result.lottery_number}</td>
                                            <td>${result.user_name}</td>
                                            <td>第${result.group_number}组</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('lotteryResultsContent').innerHTML = html;
    } catch (error) {
        showAlert(error.message, 'error');
        document.getElementById('lotteryResultsContent').innerHTML = '<p>加载失败</p>';
    }
}

async function publishLottery(lotteryId) {
    try {
        const response = await api.publishLotteryResults(lotteryId);
        showAlert(response.message, 'success');
        loadLotteryResults(); // 重新加载结果
    } catch (error) {
        showAlert(error.message, 'error');
    }
}

async function deleteLottery(lotteryId) {
    if (!confirm('确定要删除此抽签结果吗？删除后无法恢复。')) {
        return;
    }
    
    try {
        const response = await api.deleteLotteryResults(lotteryId);
        showAlert(response.message, 'success');
        loadLotteryResults(); // 重新加载结果
    } catch (error) {
        showAlert(error.message, 'error');
    }
}
</script>
{% endblock %}